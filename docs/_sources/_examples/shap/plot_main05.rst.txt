
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "_examples\shap\plot_main05.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download__examples_shap_plot_main05.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr__examples_shap_plot_main05.py:


05. Basic example
=================

.. GENERATED FROM PYTHON SOURCE LINES 5-144

.. code-block:: default
   :lineno-start: 6


    # Libraries
    import shap
    import numpy as np
    import pandas as pd
    import seaborn as sns

    import matplotlib.pyplot as plt
    import matplotlib as mpl
    import matplotlib.colorbar
    import matplotlib.colors
    import matplotlib.cm

    from mpl_toolkits.axes_grid1 import make_axes_locatable

    try:
        __file__
        TERMINAL = True
    except:
        TERMINAL = False

    # ------------------------
    # Methods
    # ------------------------
    def scalar_colormap(values, cmap, vmin, vmax):
        """This method creates a colormap based on values.
    
        Parameters
        ----------
        values : array-like
        The values to create the corresponding colors
    
        cmap : str
        The colormap
    
        vmin, vmax : float
        The minimum and maximum possible values
    
        Returns
        -------
        scalar colormap
        """
        # Create scalar mappable
        norm = mpl.colors.Normalize(vmin=vmin, vmax=vmax, clip=True)
        mapper = mpl.cm.ScalarMappable(norm=norm, cmap=cmap)
        # Get color map
        colormap = sns.color_palette([mapper.to_rgba(i) for i in values])
        # Return
        return colormap, norm


    def scalar_palette(values, cmap, vmin, vmax):
        """This method creates a colorpalette based on values.

        Parameters
        ----------
        values : array-like
        The values to create the corresponding colors

        cmap : str
        The colormap

        vmin, vmax : float
        The minimum and maximum possible values

        Returns
        -------
        scalar colormap

        """
        # Create a matplotlib colormap from name
        #cmap = sns.light_palette(cmap, reverse=False, as_cmap=True)
        cmap = sns.color_palette(cmap, as_cmap=True)
        # Normalize to the range of possible values from df["c"]
        norm = mpl.colors.Normalize(vmin=vmin, vmax=vmax)
        # Create a color dictionary (value in c : color from colormap)
        colors = {}
        for cval in values:
            colors.update({cval : cmap(norm(cval))})
        # Return
        return colors, norm


    def create_random_shap(samples, timesteps, features):
        """Create random LSTM data.

        .. note: No need to create the 3D matrix and then reshape to
                 2D. It would be possible to create directly the 2D
                 matrix.

        Parameters
        ----------
        samples: int
            The number of observations
        timesteps: int
            The number of time steps
        features: int
            The number of features

        Returns
        -------
        Stacked matrix with the data.

        """
        # .. note: Either perform a pre-processing step such as
        #          normalization or generate the features within
        #          the appropriate interval.
        # Create dataset
        x = np.random.randint(low=0, high=100,
            size=(samples, timesteps, features))
        y = np.random.randint(low=0, high=2, size=samples).astype(float)
        i = np.vstack(np.dstack(np.indices((samples, timesteps))))

        # Create DataFrame
        df = pd.DataFrame(
            data=np.hstack((i, x.reshape((-1, features)))),
            columns=['sample', 'timestep'] + \
                    ['f%s'%j for j in range(features)]
        )

        df_stack = df.set_index(['sample', 'timestep']).stack()
        df_stack = df_stack
        df_stack.name = 'shap_values'
        df_stack = df_stack.to_frame()
        df_stack.index.names = ['sample', 'timestep', 'features']
        df_stack = df_stack.reset_index()

        df_stack['feature_values'] = np.random.randint(
            low=0, high=100, size=df_stack.shape[0])

        return df_stack


    def load_shap_file():
        data = pd.read_csv('./data/shap.csv')
        data = data.iloc[: , 1:]
        #data.timestep = data.timestep - (data.timestep.nunique() - 1)
        return data








.. GENERATED FROM PYTHON SOURCE LINES 145-146

Lets generate and/or load the shap values.

.. GENERATED FROM PYTHON SOURCE LINES 146-172

.. code-block:: default
   :lineno-start: 147


    # .. note: The right format to use for plotting depends
    #          on the library we use. The data structure is
    #          good when using seaborn
    # Load data
    data = create_random_shap(10, 6, 4)
    #data = load_shap_file()
    #data = data[data['sample'] < 100]

    shap_values = pd.pivot_table(data,
            values='shap_values',
            index=['sample', 'timestep'],
            columns=['features'])

    feature_values = pd.pivot_table(data,
            values='feature_values',
            index=['sample', 'timestep'],
            columns=['features'])

    # Show
    if TERMINAL:
        print("\nShow:")
        print(data)
        print(shap_values)
        print(feature_values)








.. GENERATED FROM PYTHON SOURCE LINES 173-174

Let's see how data looks like

.. GENERATED FROM PYTHON SOURCE LINES 174-176

.. code-block:: default
   :lineno-start: 174

    data.head(10)






.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <div>
    <style scoped>
        .dataframe tbody tr th:only-of-type {
            vertical-align: middle;
        }

        .dataframe tbody tr th {
            vertical-align: top;
        }

        .dataframe thead th {
            text-align: right;
        }
    </style>
    <table border="1" class="dataframe">
      <thead>
        <tr style="text-align: right;">
          <th></th>
          <th>sample</th>
          <th>timestep</th>
          <th>features</th>
          <th>shap_values</th>
          <th>feature_values</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>0</th>
          <td>0</td>
          <td>0</td>
          <td>f0</td>
          <td>56</td>
          <td>16</td>
        </tr>
        <tr>
          <th>1</th>
          <td>0</td>
          <td>0</td>
          <td>f1</td>
          <td>55</td>
          <td>15</td>
        </tr>
        <tr>
          <th>2</th>
          <td>0</td>
          <td>0</td>
          <td>f2</td>
          <td>71</td>
          <td>13</td>
        </tr>
        <tr>
          <th>3</th>
          <td>0</td>
          <td>0</td>
          <td>f3</td>
          <td>20</td>
          <td>38</td>
        </tr>
        <tr>
          <th>4</th>
          <td>0</td>
          <td>1</td>
          <td>f0</td>
          <td>85</td>
          <td>80</td>
        </tr>
        <tr>
          <th>5</th>
          <td>0</td>
          <td>1</td>
          <td>f1</td>
          <td>92</td>
          <td>97</td>
        </tr>
        <tr>
          <th>6</th>
          <td>0</td>
          <td>1</td>
          <td>f2</td>
          <td>68</td>
          <td>94</td>
        </tr>
        <tr>
          <th>7</th>
          <td>0</td>
          <td>1</td>
          <td>f3</td>
          <td>30</td>
          <td>24</td>
        </tr>
        <tr>
          <th>8</th>
          <td>0</td>
          <td>2</td>
          <td>f0</td>
          <td>21</td>
          <td>43</td>
        </tr>
        <tr>
          <th>9</th>
          <td>0</td>
          <td>2</td>
          <td>f1</td>
          <td>25</td>
          <td>73</td>
        </tr>
      </tbody>
    </table>
    </div>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 177-178

Let's see how shap_values looks like

.. GENERATED FROM PYTHON SOURCE LINES 178-180

.. code-block:: default
   :lineno-start: 178

    shap_values.iloc[:10, :5]






.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <div>
    <style scoped>
        .dataframe tbody tr th:only-of-type {
            vertical-align: middle;
        }

        .dataframe tbody tr th {
            vertical-align: top;
        }

        .dataframe thead th {
            text-align: right;
        }
    </style>
    <table border="1" class="dataframe">
      <thead>
        <tr style="text-align: right;">
          <th></th>
          <th>features</th>
          <th>f0</th>
          <th>f1</th>
          <th>f2</th>
          <th>f3</th>
        </tr>
        <tr>
          <th>sample</th>
          <th>timestep</th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th rowspan="6" valign="top">0</th>
          <th>0</th>
          <td>56</td>
          <td>55</td>
          <td>71</td>
          <td>20</td>
        </tr>
        <tr>
          <th>1</th>
          <td>85</td>
          <td>92</td>
          <td>68</td>
          <td>30</td>
        </tr>
        <tr>
          <th>2</th>
          <td>21</td>
          <td>25</td>
          <td>39</td>
          <td>61</td>
        </tr>
        <tr>
          <th>3</th>
          <td>50</td>
          <td>76</td>
          <td>72</td>
          <td>20</td>
        </tr>
        <tr>
          <th>4</th>
          <td>8</td>
          <td>68</td>
          <td>1</td>
          <td>93</td>
        </tr>
        <tr>
          <th>5</th>
          <td>41</td>
          <td>83</td>
          <td>91</td>
          <td>70</td>
        </tr>
        <tr>
          <th rowspan="4" valign="top">1</th>
          <th>0</th>
          <td>49</td>
          <td>50</td>
          <td>52</td>
          <td>10</td>
        </tr>
        <tr>
          <th>1</th>
          <td>54</td>
          <td>68</td>
          <td>55</td>
          <td>88</td>
        </tr>
        <tr>
          <th>2</th>
          <td>32</td>
          <td>65</td>
          <td>72</td>
          <td>56</td>
        </tr>
        <tr>
          <th>3</th>
          <td>29</td>
          <td>29</td>
          <td>86</td>
          <td>56</td>
        </tr>
      </tbody>
    </table>
    </div>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 181-182

Let's see how feature_values looks like

.. GENERATED FROM PYTHON SOURCE LINES 182-185

.. code-block:: default
   :lineno-start: 182

    feature_values.iloc[:10, :5]







.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <div>
    <style scoped>
        .dataframe tbody tr th:only-of-type {
            vertical-align: middle;
        }

        .dataframe tbody tr th {
            vertical-align: top;
        }

        .dataframe thead th {
            text-align: right;
        }
    </style>
    <table border="1" class="dataframe">
      <thead>
        <tr style="text-align: right;">
          <th></th>
          <th>features</th>
          <th>f0</th>
          <th>f1</th>
          <th>f2</th>
          <th>f3</th>
        </tr>
        <tr>
          <th>sample</th>
          <th>timestep</th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th rowspan="6" valign="top">0</th>
          <th>0</th>
          <td>16</td>
          <td>15</td>
          <td>13</td>
          <td>38</td>
        </tr>
        <tr>
          <th>1</th>
          <td>80</td>
          <td>97</td>
          <td>94</td>
          <td>24</td>
        </tr>
        <tr>
          <th>2</th>
          <td>43</td>
          <td>73</td>
          <td>96</td>
          <td>71</td>
        </tr>
        <tr>
          <th>3</th>
          <td>95</td>
          <td>84</td>
          <td>15</td>
          <td>28</td>
        </tr>
        <tr>
          <th>4</th>
          <td>83</td>
          <td>0</td>
          <td>97</td>
          <td>18</td>
        </tr>
        <tr>
          <th>5</th>
          <td>39</td>
          <td>80</td>
          <td>91</td>
          <td>83</td>
        </tr>
        <tr>
          <th rowspan="4" valign="top">1</th>
          <th>0</th>
          <td>18</td>
          <td>18</td>
          <td>33</td>
          <td>89</td>
        </tr>
        <tr>
          <th>1</th>
          <td>78</td>
          <td>15</td>
          <td>92</td>
          <td>31</td>
        </tr>
        <tr>
          <th>2</th>
          <td>33</td>
          <td>33</td>
          <td>28</td>
          <td>54</td>
        </tr>
        <tr>
          <th>3</th>
          <td>51</td>
          <td>39</td>
          <td>73</td>
          <td>41</td>
        </tr>
      </tbody>
    </table>
    </div>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 186-190

Display using ``shap.summary_plot``
-----------------------------------------------

The first option is to use the ``shap`` library to plot the results.

.. GENERATED FROM PYTHON SOURCE LINES 190-199

.. code-block:: default
   :lineno-start: 191


    # Let's define/extract some useful variables.
    N = 4                                                       # max loops filter
    TIMESTEPS = len(shap_values.index.unique(level='timestep')) # number of timesteps
    SAMPLES = len(shap_values.index.unique(level='sample'))     # number of samples

    shap_min = data.shap_values.min()
    shap_max = data.shap_values.max()








.. GENERATED FROM PYTHON SOURCE LINES 200-201

Now, let's display the shap values for all features in each timestep.

.. GENERATED FROM PYTHON SOURCE LINES 201-224

.. code-block:: default
   :lineno-start: 202


    # For each timestep (visualise all features)
    for i, step in enumerate(range(TIMESTEPS)[:N]):
        # Show
        #print('%2d. %s' % (i, step))

        # .. note: First option (commented) is only necessary if we work
        #          with a numpy array. However, since we are using a DataFrame
        #          with the timestep, we can index by that index level.
        # Compute indices
        #indice = np.arange(SAMPLES)*TIMESTEPS + step
        indice = shap_values.index.get_level_values('timestep') == i

        # Create auxiliary matrices
        shap_aux = shap_values.iloc[indice]
        feat_aux = feature_values.iloc[indice]

        # Display
        plt.figure()
        plt.title("Timestep: %s" % i)
        shap.summary_plot(shap_aux.to_numpy(), feat_aux, show=False)
        plt.xlim(shap_min, shap_max)




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_001.png
         :alt: Timestep: 0
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_001.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_002.png
         :alt: Timestep: 1
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_002.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_003.png
         :alt: Timestep: 2
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_003.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_004.png
         :alt: Timestep: 3
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_004.png
         :class: sphx-glr-multi-img





.. GENERATED FROM PYTHON SOURCE LINES 225-226

Now, let's display the shap values for all timesteps of each feature.

.. GENERATED FROM PYTHON SOURCE LINES 226-247

.. code-block:: default
   :lineno-start: 227


    # For each feature (visualise all time-steps)
    for i, f in enumerate(shap_values.columns[:N]):
        # Show
        #print('%2d. %s' % (i, f))

        # Create auxiliary matrices (select feature and reshape)
        shap_aux = shap_values.iloc[:, i] \
            .to_numpy().reshape(-1, TIMESTEPS)
        feat_aux = feature_values.iloc[:, i] \
            .to_numpy().reshape(-1, TIMESTEPS)
        feat_aux = pd.DataFrame(feat_aux,
            columns=['timestep %s'%j for j in range(TIMESTEPS)]
        )

        # Show
        plt.figure()
        plt.title("Feature: %s" % f)
        shap.summary_plot(shap_aux, feat_aux, sort=False, show=False)
        plt.xlim(shap_min, shap_max)




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_005.png
         :alt: Feature: f0
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_005.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_006.png
         :alt: Feature: f1
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_006.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_007.png
         :alt: Feature: f2
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_007.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_008.png
         :alt: Feature: f3
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_008.png
         :class: sphx-glr-multi-img





.. GENERATED FROM PYTHON SOURCE LINES 248-250

.. note:: If y-axis represents timesteps the ``sort`` parameter
          in the ``summary_plot`` function is set to False.

.. GENERATED FROM PYTHON SOURCE LINES 252-260

Display using ``sns.stripplot``
-------------------------------

.. warning:: This method seems to be quite slow.

Let's display the shap values for each feature and all time steps.
In contrast to the previous example, the timesteps are now displayed
on the x-axis and the y-axis contains the shap values.

.. GENERATED FROM PYTHON SOURCE LINES 260-307

.. code-block:: default
   :lineno-start: 262



    def add_colorbar(fig, cmap, norm):
        """"""
        divider = make_axes_locatable(plt.gca())
        ax_cb = divider.new_horizontal(size="5%", pad=0.05)
        fig.add_axes(ax_cb)
        cb1 = matplotlib.colorbar.ColorbarBase(ax_cb,
             cmap=cmap, norm=norm, orientation='vertical')


    # Loop
    for i, (name, df) in enumerate(data.groupby('features')):

        # Get colormap
        values = df.feature_values
        cmap, norm = scalar_palette(values=values, cmap='coolwarm',
            vmin=values.min(), vmax=values.max())

        print(df)

        # Display
        fig, ax = plt.subplots()
        ax = sns.stripplot(x='timestep',
                           y='shap_values',
                           hue='feature_values',
                           palette=cmap,
                           data=df,
                           ax=ax)

        # Needed for older matplotlib versions
        cmap = matplotlib.cm.get_cmap('coolwarm')

        # Configure axes
        plt.title(name)
        plt.legend([], [], frameon=False)
        ax.invert_xaxis()
        add_colorbar(plt.gcf(), cmap, norm)

        # End
        if int(i) > N:
            break

    # Show
    plt.show()





.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_009.png
         :alt: f0
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_009.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_010.png
         :alt: f1
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_010.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_011.png
         :alt: f2
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_011.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_012.png
         :alt: f3
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_012.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

         sample  timestep features  shap_values  feature_values
    0         0         0       f0           56              16
    4         0         1       f0           85              80
    8         0         2       f0           21              43
    12        0         3       f0           50              95
    16        0         4       f0            8              83
    20        0         5       f0           41              39
    24        1         0       f0           49              18
    28        1         1       f0           54              78
    32        1         2       f0           32              33
    36        1         3       f0           29              51
    40        1         4       f0           55              28
    44        1         5       f0           72              26
    48        2         0       f0           34              80
    52        2         1       f0           10              25
    56        2         2       f0           80              58
    60        2         3       f0            3              68
    64        2         4       f0           12              94
    68        2         5       f0           10              12
    72        3         0       f0           53              84
    76        3         1       f0           47              23
    80        3         2       f0           68              65
    84        3         3       f0           74              40
    88        3         4       f0           29              44
    92        3         5       f0           25              55
    96        4         0       f0           68              91
    100       4         1       f0           37               6
    104       4         2       f0           73              90
    108       4         3       f0           15              32
    112       4         4       f0           38              86
    116       4         5       f0           70              49
    120       5         0       f0           23              91
    124       5         1       f0           80              19
    128       5         2       f0           98              82
    132       5         3       f0           47              56
    136       5         4       f0           79              50
    140       5         5       f0           46              76
    144       6         0       f0           43              56
    148       6         1       f0           77              86
    152       6         2       f0           72              86
    156       6         3       f0           10              26
    160       6         4       f0           26              97
    164       6         5       f0           89              13
    168       7         0       f0           31               9
    172       7         1       f0           93              10
    176       7         2       f0           41              96
    180       7         3       f0           45              31
    184       7         4       f0           10              38
    188       7         5       f0           67              29
    192       8         0       f0           18              87
    196       8         1       f0           55              68
    200       8         2       f0           49              56
    204       8         3       f0           47              86
    208       8         4       f0           16              67
    212       8         5       f0           42              20
    216       9         0       f0            7              53
    220       9         1       f0           10              82
    224       9         2       f0           84              16
    228       9         3       f0           40              63
    232       9         4       f0           25              63
    236       9         5       f0           34              94
         sample  timestep features  shap_values  feature_values
    1         0         0       f1           55              15
    5         0         1       f1           92              97
    9         0         2       f1           25              73
    13        0         3       f1           76              84
    17        0         4       f1           68               0
    21        0         5       f1           83              80
    25        1         0       f1           50              18
    29        1         1       f1           68              15
    33        1         2       f1           65              33
    37        1         3       f1           29              39
    41        1         4       f1           34              30
    45        1         5       f1           21              60
    49        2         0       f1           99              42
    53        2         1       f1           82              40
    57        2         2       f1           38              19
    61        2         3       f1           36              92
    65        2         4       f1           82              60
    69        2         5       f1           36              13
    73        3         0       f1           27              15
    77        3         1       f1           64              34
    81        3         2       f1           17              93
    85        3         3       f1            7              38
    89        3         4       f1           47              37
    93        3         5       f1            2              58
    97        4         0       f1           97              96
    101       4         1       f1           52              77
    105       4         2       f1           81              37
    109       4         3       f1           91              39
    113       4         4       f1           87              54
    117       4         5       f1           91              86
    121       5         0       f1           14              62
    125       5         1       f1           21              43
    129       5         2       f1           84              36
    133       5         3       f1           41              44
    137       5         4       f1           10              70
    141       5         5       f1           46              78
    145       6         0       f1           42              33
    149       6         1       f1           55              71
    153       6         2       f1           18              41
    157       6         3       f1           63              81
    161       6         4       f1           52              43
    165       6         5       f1           39              50
    169       7         0       f1           99              79
    173       7         1       f1           33              49
    177       7         2       f1           19              45
    181       7         3       f1           82              44
    185       7         4       f1           13               7
    189       7         5       f1           55              44
    193       8         0       f1           45              14
    197       8         1       f1           71              82
    201       8         2       f1           19              28
    205       8         3       f1           78              89
    209       8         4       f1           31              33
    213       8         5       f1           44              24
    217       9         0       f1           56              79
    221       9         1       f1           56              65
    225       9         2       f1           91              60
    229       9         3       f1           25              81
    233       9         4       f1           46              90
    237       9         5       f1           62              88
         sample  timestep features  shap_values  feature_values
    2         0         0       f2           71              13
    6         0         1       f2           68              94
    10        0         2       f2           39              96
    14        0         3       f2           72              15
    18        0         4       f2            1              97
    22        0         5       f2           91              91
    26        1         0       f2           52              33
    30        1         1       f2           55              92
    34        1         2       f2           72              28
    38        1         3       f2           86              73
    42        1         4       f2           37              32
    46        1         5       f2           81               6
    50        2         0       f2           90              59
    54        2         1       f2           63              64
    58        2         2       f2           46              84
    62        2         3       f2           90              75
    66        2         4       f2           91              29
    70        2         5       f2           13              58
    74        3         0       f2           57              80
    78        3         1       f2           94              77
    82        3         2       f2            8              60
    86        3         3       f2           89              89
    90        3         4       f2           20               5
    94        3         5       f2           69              58
    98        4         0       f2           29              16
    102       4         1       f2           70              59
    106       4         2       f2           68              59
    110       4         3       f2           94              55
    114       4         4       f2           47              55
    118       4         5       f2           91              33
    122       5         0       f2           47              94
    126       5         1       f2           72              24
    130       5         2       f2           68              93
    134       5         3       f2           61              46
    138       5         4       f2           91              98
    142       5         5       f2           76              12
    146       6         0       f2           41              44
    150       6         1       f2           79              34
    154       6         2       f2           99              40
    158       6         3       f2           33              88
    162       6         4       f2           39              65
    166       6         5       f2           85              68
    170       7         0       f2           75              14
    174       7         1       f2           80              82
    178       7         2       f2           69              75
    182       7         3       f2           21              27
    186       7         4       f2           45              53
    190       7         5       f2           96              98
    194       8         0       f2           60              34
    198       8         1       f2           32              14
    202       8         2       f2           16              96
    206       8         3       f2           85              22
    210       8         4       f2           72              64
    214       8         5       f2           78              59
    218       9         0       f2           15              37
    222       9         1       f2           30              51
    226       9         2       f2           58              15
    230       9         3       f2           14              29
    234       9         4       f2           43              41
    238       9         5       f2           38              52
         sample  timestep features  shap_values  feature_values
    3         0         0       f3           20              38
    7         0         1       f3           30              24
    11        0         2       f3           61              71
    15        0         3       f3           20              28
    19        0         4       f3           93              18
    23        0         5       f3           70              83
    27        1         0       f3           10              89
    31        1         1       f3           88              31
    35        1         2       f3           56              54
    39        1         3       f3           56              41
    43        1         4       f3           90              91
    47        1         5       f3            5              25
    51        2         0       f3            4              29
    55        2         1       f3           62               6
    59        2         2       f3           92              91
    63        2         3       f3           84              12
    67        2         4       f3           57              92
    71        2         5       f3           10              18
    75        3         0       f3            2              55
    79        3         1       f3           22              23
    83        3         2       f3           66              20
    87        3         3       f3           40              45
    91        3         4       f3           96              25
    95        3         5       f3           31              30
    99        4         0       f3           69              42
    103       4         1       f3           24              24
    107       4         2       f3           31              23
    111       4         3       f3           37              93
    115       4         4       f3           99              54
    119       4         5       f3           28              58
    123       5         0       f3           52              39
    127       5         1       f3            7              10
    131       5         2       f3           14              33
    135       5         3       f3           57              85
    139       5         4       f3           43               7
    143       5         5       f3           36              49
    147       6         0       f3           80              60
    151       6         1       f3           86              86
    155       6         2       f3           73              71
    159       6         3       f3           64              15
    163       6         4       f3           54              44
    167       6         5       f3            6              53
    171       7         0       f3           35              56
    175       7         1       f3            8              45
    179       7         2       f3           69              19
    183       7         3       f3           70              70
    187       7         4       f3           10              73
    191       7         5       f3           85              91
    195       8         0       f3           23              20
    199       8         1       f3           23              40
    203       8         2       f3           32              90
    207       8         3       f3           43              92
    211       8         4       f3           82              84
    215       8         5       f3           34              76
    219       9         0       f3           30              69
    223       9         1       f3           31              97
    227       9         2       f3            6              13
    231       9         3       f3            4              12
    235       9         4       f3           97              51
    239       9         5       f3           88              85




.. GENERATED FROM PYTHON SOURCE LINES 308-317

Display using ``sns.swarmplot``
-------------------------------

.. note: If the number of samples is too high, the points overlap
         and are ignored by the ``swarmplot`` library. In such scenario
         it is better to use ``stripplot``.


Let's display the shap values for each timestep.

.. GENERATED FROM PYTHON SOURCE LINES 317-394

.. code-block:: default
   :lineno-start: 318


    # Loop
    for i, (name, df) in enumerate(data.groupby('features')):

        # Get colormap
        values = df.feature_values
        cmap, norm = scalar_palette(values=values, cmap='coolwarm',
            vmin=values.min(), vmax=values.max())

        # Display
        fig, ax = plt.subplots()
        ax = sns.swarmplot(x='timestep',
                           y='shap_values',
                           hue='feature_values',
                           palette=cmap,
                           data=df,
                           size=2,
                           ax=ax)

        # Needed for older matplotlib versions
        cmap = matplotlib.cm.get_cmap('coolwarm')

        # Configure axes
        plt.title(name)
        plt.legend([], [], frameon=False)
        ax.invert_xaxis()
        add_colorbar(plt.gcf(), cmap, norm)

        # End
        if int(i) > N:
            break

    # Show
    plt.show()







    """
    sns.set_theme(style="ticks")

    # Create a dataset with many short random walks
    rs = np.random.RandomState(4)
    pos = rs.randint(-1, 2, (20, 5)).cumsum(axis=1)
    pos -= pos[:, 0, np.newaxis]
    step = np.tile(range(5), 20)
    walk = np.repeat(range(20), 5)
    df = pd.DataFrame(np.c_[pos.flat, step, walk],
                      columns=["position", "step", "walk"])
    # Initialize a grid of plots with an Axes for each walk
    #grid = sns.FacetGrid(df_stack, col="walk", hue="f", palette="tab20c",
    #                     col_wrap=4, height=1.5)

    grid = sns.FacetGrid(df_stack, hue="f",
        palette="tab20c", height=1.5)

    # Draw a horizontal line to show the starting point
    grid.refline(y=0, linestyle=":")

    # Draw a line plot to show the trajectory of each random walk
    grid.map(plt.plot, "t", "value", marker="o")

    # Adjust the tick positions and labels
    grid.set(xticks=np.arange(5), yticks=[-3, 3],
             xlim=(-.5, 4.5), ylim=(-3.5, 3.5))

    # Adjust the arrangement of the plots
    grid.fig.tight_layout(w_pad=1)

    """


    #plt.show()




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_013.png
         :alt: f0
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_013.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_014.png
         :alt: f1
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_014.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_015.png
         :alt: f2
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_015.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /_examples/shap/images/sphx_glr_plot_main05_016.png
         :alt: f3
         :srcset: /_examples/shap/images/sphx_glr_plot_main05_016.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none


    '\nsns.set_theme(style="ticks")\n\n# Create a dataset with many short random walks\nrs = np.random.RandomState(4)\npos = rs.randint(-1, 2, (20, 5)).cumsum(axis=1)\npos -= pos[:, 0, np.newaxis]\nstep = np.tile(range(5), 20)\nwalk = np.repeat(range(20), 5)\ndf = pd.DataFrame(np.c_[pos.flat, step, walk],\n                  columns=["position", "step", "walk"])\n# Initialize a grid of plots with an Axes for each walk\n#grid = sns.FacetGrid(df_stack, col="walk", hue="f", palette="tab20c",\n#                     col_wrap=4, height=1.5)\n\ngrid = sns.FacetGrid(df_stack, hue="f",\n    palette="tab20c", height=1.5)\n\n# Draw a horizontal line to show the starting point\ngrid.refline(y=0, linestyle=":")\n\n# Draw a line plot to show the trajectory of each random walk\ngrid.map(plt.plot, "t", "value", marker="o")\n\n# Adjust the tick positions and labels\ngrid.set(xticks=np.arange(5), yticks=[-3, 3],\n         xlim=(-.5, 4.5), ylim=(-3.5, 3.5))\n\n# Adjust the arrangement of the plots\ngrid.fig.tight_layout(w_pad=1)\n\n'



.. GENERATED FROM PYTHON SOURCE LINES 395-398

Display using ``sns.FacetGrid``
-------------------------------


.. GENERATED FROM PYTHON SOURCE LINES 398-404

.. code-block:: default
   :lineno-start: 399


    #g = sns.FacetGrid(df_stack, col="f", hue='original')
    #g.map(sns.swarmplot, "t", "value", alpha=.7)
    #g.add_legend()









.. GENERATED FROM PYTHON SOURCE LINES 405-408

Display using ``shap.beeswarm``
-------------------------------


.. GENERATED FROM PYTHON SOURCE LINES 408-413

.. code-block:: default
   :lineno-start: 409


    # REF: https://github.com/slundberg/shap/blob/master/shap/plots/_beeswarm.py
    #
    # .. note: It needs a kernel explainer, and while it works with
    #          common kernels (plot_main07.py) it does not work with
    #          the DeepKernel for some reason (mask related).







.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  4.108 seconds)


.. _sphx_glr_download__examples_shap_plot_main05.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_main05.py <plot_main05.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_main05.ipynb <plot_main05.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
