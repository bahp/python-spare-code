<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drug Resistance Index &mdash; python-spare-code 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/python_icon_191765.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Generate data AST" href="plot_generate_data_AST.html" />
    <link rel="prev" title="Collateral Sensitivity Index" href="plot_collateral_sensitivity.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            python-spare-code
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/introduction.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">General</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#explainer-dashboard">Explainer Dashboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#factory-boy">Factory Boy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#jsonpickle">jsonpickle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#ldap">LDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#matplotlib-seaborn">Matplotlib / Seaborn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#other">Other</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#pandas">Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#plotly">Plotly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#scikits">Scikits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#shap">Shap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tableone">TableOne</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tensorflow">Tensorflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tpot">TPOT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#ukvi-trips">UKVI Trips</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#utils">Utils</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="mic.html">MIC package</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_collateral_sensitivity.html">Collateral Sensitivity Index</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Drug Resistance Index</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-example-using-cddep-tutorial">a) Example using CDDEP (tutorial)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#b-example-using-cddep-raw">b) Example using CDDEP (raw)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-example-using-mimic">c) Example using MIMIC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plot_generate_data_AST.html">Generate data AST</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multi_armed_bandit.html">Multi-Armed bandit problems</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_mutual_information.html">Mutual Information Criteria</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_planet_orbit_v1.html">Drawing a planet orbit (stackoverflow)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_planet_orbit_v2.html">Drawing a planet orbit (customised)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_scale_colormap.html">Show colormap for various scalings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">python-spare-code</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">General</a></li>
      <li class="breadcrumb-item active">Drug Resistance Index</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/_examples/utils/plot_drug_resistance_index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-examples-utils-plot-drug-resistance-index-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="drug-resistance-index">
<span id="sphx-glr-examples-utils-plot-drug-resistance-index-py"></span><h1>Drug Resistance Index<a class="headerlink" href="#drug-resistance-index" title="Permalink to this heading"></a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">DRI</span></code> measures changes through time in the proportion of disease-causing
pathogens that are resistant to the antibiotics commonly used to treat them.
The annual percentage change in the <code class="docutils literal notranslate"><span class="pre">DRI</span></code> is a measure of the rate of depletion
of antibiotic effectiveness.</p>
<p>Since antibiotic use may change over time in response to changing levels of
antibiotic resistance, we compare trends in the index with the counterfactual
case, where antibiotic use remains fixed to a baseline year. A static-use <code class="docutils literal notranslate"><span class="pre">DRI</span></code>
allows assessment of the extent to which drug use has adapted in response to
resistance and the burden that this resistance would have caused if antibiotic
use patterns had not changed. Changing antibiotic use patterns over time may
mitigate the burden of antibiotic resistance. To incorporate changing trends
in antibiotic use, we also construct an adaptive version of the <code class="docutils literal notranslate"><span class="pre">DRI</span></code>.</p>
<div class="math notranslate nohighlight">
\[R\_fixed(i) = \sum_{k}{p_{i,k}^{t} * q_{i,k}^{0}}\]</div>
<div class="math notranslate nohighlight">
\[R(i) = \sum_{k}{p_{i,k}^{t} * q_{i,k}^{t}}\]</div>
<p>where</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>t</strong> is time</p></li>
<li><p><strong>i</strong> is the microorganism</p></li>
<li><p><strong>k</strong> is the antimicrobial</p></li>
<li><p><strong>p</strong> is the proportion of resistance among organism <strong>i</strong> to drug <strong>k</strong> at time t</p></li>
<li><p><strong>q</strong> is the frequency of drug <strong>k</strong> used to treat organism in at time <strong>t</strong>.</p></li>
</ul>
</div></blockquote>
<p>See below for a few resources.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="http://antimicrob.net/wp-content/uploads/DRI-instructions_engl.pdf">R1</a>: How to calculate DRI? (CDDEP)</p></li>
<li><p><a class="reference external" href="https://www.cidrap.umn.edu/antimicrobial-stewardship/new-metric-aims-simplify-how-global-resistance-measured">R2</a>: New metric aims to simplify how global resistance is measured (POST)</p></li>
<li><p><a class="reference external" href="https://bmjopen.bmj.com/content/1/2/e000135">R3</a>: Communicating trends in resistance using DRI.</p></li>
<li><p><a class="reference external" href="https://gh.bmj.com/content/4/2/e001315">R4</a>: Tracking global trends in the effectiveness of antibiotic therapy.</p></li>
<li><p><a class="reference external" href="https://gh.bmj.com/content/4/4/e001838">R5</a>: The proposed DRI is not a good measure of antibiotic effectiveness.</p></li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">51</span> <span class="c1"># Libraries</span>
<span class="linenos">52</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos">53</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos">54</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="linenos">55</span>
<span class="linenos">56</span> <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="linenos">57</span>
<span class="linenos">58</span> <span class="k">def</span> <span class="nf">print_example_heading</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="linenos">59</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Example </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="linenos">60</span>
<span class="linenos">61</span> <span class="k">try</span><span class="p">:</span>
<span class="linenos">62</span>     <span class="vm">__file__</span>
<span class="linenos">63</span>     <span class="n">TERMINAL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">64</span> <span class="k">except</span><span class="p">:</span>
<span class="linenos">65</span>     <span class="n">TERMINAL</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<section id="a-example-using-cddep-tutorial">
<h2>a) Example using CDDEP (tutorial)<a class="headerlink" href="#a-example-using-cddep-tutorial" title="Permalink to this heading"></a></h2>
<p>The Drug Resistance Index or <a href="#id1"><span class="problematic" id="id2">``</span></a>DRI``can be calculated at the facility or individual
ward level to measure the performance of stewardship efforts. The index can
be calculated in three simple steps using the pharmacy and antibiogram data
available in most hospitals.</p>
<p>The CDDEP recommends to aggregate susceptibility tests results by species
and class of antimicrobials (see note). Laboratories and hospital antibiograms
report susceptibility results by individual antibiotic compound. However, certain
drugs may be widely tested to proxy for the effectiveness of an entire class in
vitro, although they are rarely used in clinical practice (e.g. oxacillin tests
for all b-lactam activity against staphylococci, nalidixic axic for quinolone
activity in Gram-negative uropathogens). In addition, not all drugs on formulary
may be included in laboratory testing. Therefore, when matching resistance data to
antibiotic utilization, we recommend grouping results by broader therapeutic class.
The optimal grouping will depend on many factors such as the species being included
in the index, facility formulary and testing practices etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 89</span> <span class="c1"># This sample data was copied from the CDDEP reference (R1) to</span>
<span class="linenos"> 90</span> <span class="c1"># evaluate whether the Drug Resistance Index is being computed</span>
<span class="linenos"> 91</span> <span class="c1"># correctly.</span>
<span class="linenos"> 92</span> <span class="n">cddep</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 93</span>     <span class="p">[</span><span class="s1">&#39;Q2 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;AMINOPENICILLINS&#39;</span><span class="p">,</span> <span class="mi">329</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
<span class="linenos"> 94</span>     <span class="p">[</span><span class="s1">&#39;Q2 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;B-LACTAM, INCREASED ACTIVITY&#39;</span><span class="p">,</span> <span class="mi">554</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span>  <span class="mi">250</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
<span class="linenos"> 95</span>     <span class="p">[</span><span class="s1">&#39;Q2 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;G3 CEPHALOSPORINS&#39;</span><span class="p">,</span> <span class="mi">287</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
<span class="linenos"> 96</span>     <span class="p">[</span><span class="s1">&#39;Q2 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;QUINOLONES, SYSTEMIC&#39;</span><span class="p">,</span> <span class="mi">293</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span>  <span class="mi">250</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
<span class="linenos"> 97</span>     <span class="p">[</span><span class="s1">&#39;Q2 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;SULFA &amp; TRIMETH COMB&#39;</span><span class="p">,</span> <span class="mi">334</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span>  <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
<span class="linenos"> 98</span>     <span class="p">[</span><span class="s1">&#39;Q3 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;AMINOPENICILLINS&#39;</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">1100</span><span class="p">],</span>
<span class="linenos"> 99</span>     <span class="p">[</span><span class="s1">&#39;Q3 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;B-LACTAM, INCREASED ACTIVITY&#39;</span><span class="p">,</span> <span class="mi">408</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">],</span>
<span class="linenos">100</span>     <span class="p">[</span><span class="s1">&#39;Q3 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;G3 CEPHALOSPORINS&#39;</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">1100</span><span class="p">],</span>
<span class="linenos">101</span>     <span class="p">[</span><span class="s1">&#39;Q3 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;QUINOLONES, SYSTEMIC&#39;</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">],</span>
<span class="linenos">102</span>     <span class="p">[</span><span class="s1">&#39;Q3 2011&#39;</span><span class="p">,</span> <span class="s1">&#39;E. Coli&#39;</span><span class="p">,</span> <span class="s1">&#39;SULFA &amp; TRIMETH COMB&#39;</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1100</span><span class="p">]</span>
<span class="linenos">103</span> <span class="p">]</span>
<span class="linenos">104</span>
<span class="linenos">105</span> <span class="c1"># Create DataFrame</span>
<span class="linenos">106</span> <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cddep</span><span class="p">,</span>
<span class="linenos">107</span>     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="s1">&#39;abx&#39;</span><span class="p">,</span> <span class="s1">&#39;isolates&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="s1">&#39;use_period&#39;</span><span class="p">])</span>
<span class="linenos">108</span>
<span class="linenos">109</span> <span class="c1"># Format DataFrame</span>
<span class="linenos">110</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">isolates</span> <span class="o">-</span> <span class="n">df1</span><span class="o">.</span><span class="n">R</span>
<span class="linenos">111</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;r_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> <span class="n">df1</span><span class="o">.</span><span class="n">S</span><span class="p">))</span>    <span class="c1">#.round(decimals=2)</span>
<span class="linenos">112</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;u_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">use</span> <span class="o">/</span> <span class="n">df1</span><span class="o">.</span><span class="n">use_period</span><span class="p">)</span> <span class="c1">#.round(decimals=2)</span>
<span class="linenos">113</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;w_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">r_rate</span> <span class="o">*</span> <span class="n">df1</span><span class="o">.</span><span class="n">u_weight</span><span class="p">)</span>  <span class="c1">#.round(decimals=3)</span>
<span class="linenos">114</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;dri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">w_rate</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
<p>Lets see the results</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">118</span> <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">119</span>     <span class="n">print_example_heading</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">120</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result (CDDEP):&#39;</span><span class="p">)</span>
<span class="linenos">121</span>     <span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
<span class="linenos">122</span> <span class="n">df1</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>org</th>
      <th>abx</th>
      <th>isolates</th>
      <th>R</th>
      <th>use</th>
      <th>use_period</th>
      <th>S</th>
      <th>r_rate</th>
      <th>u_weight</th>
      <th>w_rate</th>
      <th>dri</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>329</td>
      <td>139</td>
      <td>300</td>
      <td>1000</td>
      <td>190</td>
      <td>0.422</td>
      <td>0.300</td>
      <td>0.127</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>B-LACTAM, INCREASED ACTIVITY</td>
      <td>554</td>
      <td>72</td>
      <td>250</td>
      <td>1000</td>
      <td>482</td>
      <td>0.130</td>
      <td>0.250</td>
      <td>0.032</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>G3 CEPHALOSPORINS</td>
      <td>287</td>
      <td>3</td>
      <td>100</td>
      <td>1000</td>
      <td>284</td>
      <td>0.010</td>
      <td>0.100</td>
      <td>0.001</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>QUINOLONES, SYSTEMIC</td>
      <td>293</td>
      <td>41</td>
      <td>250</td>
      <td>1000</td>
      <td>252</td>
      <td>0.140</td>
      <td>0.250</td>
      <td>0.035</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>SULFA &amp; TRIMETH COMB</td>
      <td>334</td>
      <td>75</td>
      <td>100</td>
      <td>1000</td>
      <td>259</td>
      <td>0.225</td>
      <td>0.100</td>
      <td>0.022</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Q3 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>231</td>
      <td>101</td>
      <td>250</td>
      <td>1100</td>
      <td>130</td>
      <td>0.437</td>
      <td>0.227</td>
      <td>0.099</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Q3 2011</td>
      <td>E. Coli</td>
      <td>B-LACTAM, INCREASED ACTIVITY</td>
      <td>408</td>
      <td>54</td>
      <td>300</td>
      <td>1100</td>
      <td>354</td>
      <td>0.132</td>
      <td>0.273</td>
      <td>0.036</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Q3 2011</td>
      <td>E. Coli</td>
      <td>G3 CEPHALOSPORINS</td>
      <td>211</td>
      <td>3</td>
      <td>150</td>
      <td>1100</td>
      <td>208</td>
      <td>0.014</td>
      <td>0.136</td>
      <td>0.002</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Q3 2011</td>
      <td>E. Coli</td>
      <td>QUINOLONES, SYSTEMIC</td>
      <td>218</td>
      <td>36</td>
      <td>300</td>
      <td>1100</td>
      <td>182</td>
      <td>0.165</td>
      <td>0.273</td>
      <td>0.045</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Q3 2011</td>
      <td>E. Coli</td>
      <td>SULFA &amp; TRIMETH COMB</td>
      <td>236</td>
      <td>55</td>
      <td>100</td>
      <td>1100</td>
      <td>181</td>
      <td>0.233</td>
      <td>0.091</td>
      <td>0.021</td>
      <td>0.204</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="b-example-using-cddep-raw">
<h2>b) Example using CDDEP (raw)<a class="headerlink" href="#b-example-using-cddep-raw" title="Permalink to this heading"></a></h2>
<p>In the previous example we computed the Drug Resistance Index or <code class="docutils literal notranslate"><span class="pre">DRI</span></code>
using the summary table provided by CDDEP. While this table is useful
to understand the implementation of the Drug Resistance Index, the
values contained in the columns (e.g. isolates, R, use or use_period)
need to be computed from the raw susceptibility test data. This example
shows how to go from raw susceptibility test and prescription data to
the summary table in order to compute the <code class="docutils literal notranslate"><span class="pre">DRI</span></code>.</p>
<p>First, let’s create the raw data from the summary table provided by CDDEP.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">141</span> <span class="k">def</span> <span class="nf">create_raw_data_from_summary_table</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="linenos">142</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Create raw susceptibility and prescription data from summary.</span>
<span class="linenos">143</span>
<span class="linenos">144</span><span class="sd">     Parameters</span>
<span class="linenos">145</span><span class="sd">     ----------</span>
<span class="linenos">146</span><span class="sd">     df: pd.DataFrame</span>
<span class="linenos">147</span><span class="sd">         DataFrame with the summary data</span>
<span class="linenos">148</span>
<span class="linenos">149</span><span class="sd">     Returns</span>
<span class="linenos">150</span><span class="sd">     -------</span>
<span class="linenos">151</span>
<span class="linenos">152</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">153</span>     <span class="c1"># Variable</span>
<span class="linenos">154</span>     <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="s1">&#39;abx&#39;</span><span class="p">]</span>
<span class="linenos">155</span>
<span class="linenos">156</span>     <span class="c1"># Indexes</span>
<span class="linenos">157</span>     <span class="n">idxr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
<span class="linenos">158</span>     <span class="n">idxs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
<span class="linenos">159</span>     <span class="n">idxu</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">use</span><span class="p">)</span>
<span class="linenos">160</span>
<span class="linenos">161</span>     <span class="c1"># Compute partial DataFrames</span>
<span class="linenos">162</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">idxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">sensitivity</span><span class="o">=</span><span class="s1">&#39;resistant&#39;</span><span class="p">)</span>
<span class="linenos">163</span>     <span class="n">s</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">sensitivity</span><span class="o">=</span><span class="s1">&#39;sensitive&#39;</span><span class="p">)</span>
<span class="linenos">164</span>     <span class="n">u</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">idxu</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dose</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">)</span>
<span class="linenos">165</span>
<span class="linenos">166</span>     <span class="c1"># Return</span>
<span class="linenos">167</span>     <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">]),</span> <span class="n">u</span>
<span class="linenos">168</span>
<span class="linenos">169</span>
<span class="linenos">170</span> <span class="c1"># .. note:: Uncomment if you need to create a simulation of</span>
<span class="linenos">171</span> <span class="c1">#           the raw susceptibility and prescription data based</span>
<span class="linenos">172</span> <span class="c1">#           on the aggregated measurements.</span>
<span class="linenos">173</span>
<span class="linenos">174</span> <span class="c1"># Create raw data.</span>
<span class="linenos">175</span> <span class="n">susceptibility</span><span class="p">,</span> <span class="n">prescription</span> <span class="o">=</span> \
<span class="linenos">176</span>     <span class="n">create_raw_data_from_summary_table</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
<span class="linenos">177</span>
<span class="linenos">178</span> <span class="c1"># Save</span>
<span class="linenos">179</span> <span class="c1">#susceptibility.to_csv(&#39;./data/cddep/susceptibility.csv&#39;)</span>
<span class="linenos">180</span> <span class="c1">#prescription.to_csv(&#39;./data/cddep/prescription.csv&#39;)</span>
</pre></div>
</div>
<p>Lets visualise microbiology data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">184</span> <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">185</span>     <span class="n">print_example_heading</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">186</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Susceptibility:&#39;</span><span class="p">)</span>
<span class="linenos">187</span>     <span class="nb">print</span><span class="p">(</span><span class="n">susceptibility</span><span class="p">)</span>
<span class="linenos">188</span> <span class="n">susceptibility</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>org</th>
      <th>abx</th>
      <th>sensitivity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>resistant</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>resistant</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>resistant</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>resistant</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>resistant</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Lets visualise the prescription data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">192</span> <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">193</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Prescription:&#39;</span><span class="p">)</span>
<span class="linenos">194</span>     <span class="nb">print</span><span class="p">(</span><span class="n">prescription</span><span class="p">)</span>
<span class="linenos">195</span> <span class="n">prescription</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>org</th>
      <th>abx</th>
      <th>dose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>standard</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>standard</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>standard</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>standard</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Q2 2011</td>
      <td>E. Coli</td>
      <td>AMINOPENICILLINS</td>
      <td>standard</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Lets compute the DRI</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">200</span> <span class="c1"># -------------------------------------------</span>
<span class="linenos">201</span> <span class="c1"># Compute SARI</span>
<span class="linenos">202</span> <span class="c1"># -------------------------------------------</span>
<span class="linenos">203</span> <span class="c1"># Libraries</span>
<span class="linenos">204</span> <span class="kn">from</span> <span class="nn">pyamr.core.sari</span> <span class="kn">import</span> <span class="n">SARI</span>
<span class="linenos">205</span>
<span class="linenos">206</span> <span class="c1"># Create sari instance</span>
<span class="linenos">207</span> <span class="n">sari</span> <span class="o">=</span> <span class="n">SARI</span><span class="p">(</span><span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
<span class="linenos">208</span>                      <span class="s1">&#39;org&#39;</span><span class="p">,</span>
<span class="linenos">209</span>                      <span class="s1">&#39;abx&#39;</span><span class="p">,</span>
<span class="linenos">210</span>                      <span class="s1">&#39;sensitivity&#39;</span><span class="p">])</span>
<span class="linenos">211</span>
<span class="linenos">212</span> <span class="c1"># Compute SARI</span>
<span class="linenos">213</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">sari</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">susceptibility</span><span class="p">,</span> <span class="n">return_frequencies</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">214</span>
<span class="linenos">215</span> <span class="c1"># -------------------------------------------</span>
<span class="linenos">216</span> <span class="c1"># Compute DRI</span>
<span class="linenos">217</span> <span class="c1"># -------------------------------------------</span>
<span class="linenos">218</span>
<span class="linenos">219</span> <span class="k">def</span> <span class="nf">compute_drug_resistance_index</span><span class="p">(</span><span class="n">summry</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span>
<span class="linenos">220</span>                                   <span class="n">cu</span><span class="o">=</span><span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="n">cr</span><span class="o">=</span><span class="s1">&#39;sari&#39;</span><span class="p">,</span> <span class="n">ct</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">):</span>
<span class="linenos">221</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Computes the Drug Resistance Index</span>
<span class="linenos">222</span>
<span class="linenos">223</span><span class="sd">     Parameters</span>
<span class="linenos">224</span><span class="sd">     ----------</span>
<span class="linenos">225</span><span class="sd">     summry: pd.DataFrame</span>
<span class="linenos">226</span><span class="sd">         The summary DataFrame with columns including use,</span>
<span class="linenos">227</span><span class="sd">         resistance and time.</span>
<span class="linenos">228</span><span class="sd">     groupby:</span>
<span class="linenos">229</span><span class="sd">         The elements to groupby as described in pandas.</span>
<span class="linenos">230</span><span class="sd">     cu: str</span>
<span class="linenos">231</span><span class="sd">         Column name with use</span>
<span class="linenos">232</span><span class="sd">     cr: str</span>
<span class="linenos">233</span><span class="sd">         Column name with resistance</span>
<span class="linenos">234</span><span class="sd">     ct: str</span>
<span class="linenos">235</span><span class="sd">         Column name with time</span>
<span class="linenos">236</span>
<span class="linenos">237</span><span class="sd">     Returns</span>
<span class="linenos">238</span><span class="sd">     -------</span>
<span class="linenos">239</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">240</span>     <span class="c1"># Clone matrix</span>
<span class="linenos">241</span>     <span class="n">m</span> <span class="o">=</span> <span class="n">summry</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">242</span>
<span class="linenos">243</span>     <span class="c1"># Compute</span>
<span class="linenos">244</span>     <span class="n">m</span><span class="p">[</span><span class="s1">&#39;use_period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span> \
<span class="linenos">245</span>         <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">groupby</span><span class="p">)[</span><span class="n">cu</span><span class="p">]</span> \
<span class="linenos">246</span>         <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="linenos">247</span>     <span class="n">m</span><span class="p">[</span><span class="s1">&#39;u_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">cu</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">use_period</span><span class="p">)</span>  <span class="c1"># .round(decimals=2)</span>
<span class="linenos">248</span>     <span class="n">m</span><span class="p">[</span><span class="s1">&#39;w_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">cr</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">u_weight</span><span class="p">)</span>  <span class="c1"># .round(decimals=3)</span>
<span class="linenos">249</span>     <span class="n">m</span><span class="p">[</span><span class="s1">&#39;dri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span> \
<span class="linenos">250</span>         <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">ct</span><span class="p">)</span><span class="o">.</span><span class="n">w_rate</span> \
<span class="linenos">251</span>         <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="linenos">252</span>
<span class="linenos">253</span>     <span class="c1"># Return</span>
<span class="linenos">254</span>     <span class="k">return</span> <span class="n">m</span>
<span class="linenos">255</span>
<span class="linenos">256</span>
<span class="linenos">257</span>
<span class="linenos">258</span> <span class="c1"># Compute the number of prescriptions</span>
<span class="linenos">259</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">prescription</span> \
<span class="linenos">260</span>     <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="s1">&#39;abx&#39;</span><span class="p">])</span> \
<span class="linenos">261</span>     <span class="o">.</span><span class="n">dose</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;use&#39;</span><span class="p">)</span>
<span class="linenos">262</span>
<span class="linenos">263</span> <span class="c1"># Merge susceptibility and prescription data</span>
<span class="linenos">264</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
<span class="linenos">265</span>     <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="s1">&#39;abx&#39;</span><span class="p">],</span>
<span class="linenos">266</span>     <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="s1">&#39;abx&#39;</span><span class="p">])</span>
<span class="linenos">267</span>
<span class="linenos">268</span> <span class="c1"># Compute drug resistance index</span>
<span class="linenos">269</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">compute_drug_resistance_index</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Lets see the results</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">274</span> <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">275</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result (CDDEP):&#39;</span><span class="p">)</span>
<span class="linenos">276</span>     <span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
<span class="linenos">277</span> <span class="n">df2</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>resistant</th>
      <th>sensitive</th>
      <th>freq</th>
      <th>sari</th>
      <th>use</th>
      <th>use_period</th>
      <th>u_weight</th>
      <th>w_rate</th>
      <th>dri</th>
    </tr>
    <tr>
      <th>time</th>
      <th>org</th>
      <th>abx</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">Q2 2011</th>
      <th rowspan="5" valign="top">E. Coli</th>
      <th>AMINOPENICILLINS</th>
      <td>139</td>
      <td>190</td>
      <td>329</td>
      <td>0.422</td>
      <td>300</td>
      <td>1000</td>
      <td>0.300</td>
      <td>0.127</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>B-LACTAM, INCREASED ACTIVITY</th>
      <td>72</td>
      <td>482</td>
      <td>554</td>
      <td>0.130</td>
      <td>250</td>
      <td>1000</td>
      <td>0.250</td>
      <td>0.032</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>G3 CEPHALOSPORINS</th>
      <td>3</td>
      <td>284</td>
      <td>287</td>
      <td>0.010</td>
      <td>100</td>
      <td>1000</td>
      <td>0.100</td>
      <td>0.001</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>QUINOLONES, SYSTEMIC</th>
      <td>41</td>
      <td>252</td>
      <td>293</td>
      <td>0.140</td>
      <td>250</td>
      <td>1000</td>
      <td>0.250</td>
      <td>0.035</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th>SULFA &amp; TRIMETH COMB</th>
      <td>75</td>
      <td>259</td>
      <td>334</td>
      <td>0.225</td>
      <td>100</td>
      <td>1000</td>
      <td>0.100</td>
      <td>0.022</td>
      <td>0.218</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">Q3 2011</th>
      <th rowspan="5" valign="top">E. Coli</th>
      <th>AMINOPENICILLINS</th>
      <td>101</td>
      <td>130</td>
      <td>231</td>
      <td>0.437</td>
      <td>250</td>
      <td>1100</td>
      <td>0.227</td>
      <td>0.099</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>B-LACTAM, INCREASED ACTIVITY</th>
      <td>54</td>
      <td>354</td>
      <td>408</td>
      <td>0.132</td>
      <td>300</td>
      <td>1100</td>
      <td>0.273</td>
      <td>0.036</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>G3 CEPHALOSPORINS</th>
      <td>3</td>
      <td>208</td>
      <td>211</td>
      <td>0.014</td>
      <td>150</td>
      <td>1100</td>
      <td>0.136</td>
      <td>0.002</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>QUINOLONES, SYSTEMIC</th>
      <td>36</td>
      <td>182</td>
      <td>218</td>
      <td>0.165</td>
      <td>300</td>
      <td>1100</td>
      <td>0.273</td>
      <td>0.045</td>
      <td>0.204</td>
    </tr>
    <tr>
      <th>SULFA &amp; TRIMETH COMB</th>
      <td>55</td>
      <td>181</td>
      <td>236</td>
      <td>0.233</td>
      <td>100</td>
      <td>1100</td>
      <td>0.091</td>
      <td>0.021</td>
      <td>0.204</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /></section>
<section id="c-example-using-mimic">
<h2>c) Example using MIMIC<a class="headerlink" href="#c-example-using-mimic" title="Permalink to this heading"></a></h2>
<p>In this example, we will compute the Drug Resistance Index or <code class="docutils literal notranslate"><span class="pre">DRI</span></code> using
the freely-available <code class="docutils literal notranslate"><span class="pre">MIMIC</span></code> database which provides both susceptibility
test data and prescriptions for a large number of patients admitted from
2008 to 2019. Please note that for de-identification purpose the dates were
shifted into the future.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example we will be counting each entry in the
prescription data as one ‘standard’ dose for clarity. However,
this could be implemented more accurately by computing
for example the complete dosage.</p>
</div>
<p>First, lets load the susceptibility and prescription data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">300</span> <span class="c1"># subset</span>
<span class="linenos">301</span> <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">302</span>     <span class="s1">&#39;time&#39;</span><span class="p">,</span>
<span class="linenos">303</span>     <span class="s1">&#39;laboratory_number&#39;</span><span class="p">,</span>
<span class="linenos">304</span>     <span class="s1">&#39;specimen_code&#39;</span><span class="p">,</span>
<span class="linenos">305</span>     <span class="s1">&#39;microorganism_code&#39;</span><span class="p">,</span>
<span class="linenos">306</span>     <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">,</span>
<span class="linenos">307</span>     <span class="s1">&#39;sensitivity&#39;</span>
<span class="linenos">308</span> <span class="p">]</span>
<span class="linenos">309</span>
<span class="linenos">310</span> <span class="c1"># -----------------------------</span>
<span class="linenos">311</span> <span class="c1"># Load susceptibility test data</span>
<span class="linenos">312</span> <span class="c1"># -----------------------------</span>
<span class="linenos">313</span> <span class="c1"># Load data</span>
<span class="linenos">314</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./data/mimic&#39;</span><span class="p">)</span>
<span class="linenos">315</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;microbiologyevents.csv&#39;</span><span class="p">)</span>
<span class="linenos">316</span>
<span class="linenos">317</span> <span class="c1"># Rename columns</span>
<span class="linenos">318</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">319</span>     <span class="s1">&#39;chartdate&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
<span class="linenos">320</span>     <span class="s1">&#39;micro_specimen_id&#39;</span><span class="p">:</span> <span class="s1">&#39;laboratory_number&#39;</span><span class="p">,</span>
<span class="linenos">321</span>     <span class="s1">&#39;spec_type_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;specimen_code&#39;</span><span class="p">,</span>
<span class="linenos">322</span>     <span class="s1">&#39;org_name&#39;</span><span class="p">:</span> <span class="s1">&#39;microorganism_code&#39;</span><span class="p">,</span>
<span class="linenos">323</span>     <span class="s1">&#39;ab_name&#39;</span><span class="p">:</span> <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">,</span>
<span class="linenos">324</span>     <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="s1">&#39;sensitivity&#39;</span>
<span class="linenos">325</span> <span class="p">})</span>
<span class="linenos">326</span>
<span class="linenos">327</span> <span class="c1"># Format data</span>
<span class="linenos">328</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
<span class="linenos">329</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>
<span class="linenos">330</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
<span class="linenos">331</span> <span class="n">data</span><span class="o">.</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span>
<span class="linenos">332</span>     <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="s1">&#39;sensitive&#39;</span><span class="p">,</span>
<span class="linenos">333</span>     <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;resistant&#39;</span><span class="p">,</span>
<span class="linenos">334</span>     <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="s1">&#39;intermediate&#39;</span><span class="p">,</span>
<span class="linenos">335</span>     <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;pass&#39;</span>
<span class="linenos">336</span> <span class="p">})</span>
<span class="linenos">337</span>
<span class="linenos">338</span>
<span class="linenos">339</span> <span class="c1"># ------------------</span>
<span class="linenos">340</span> <span class="c1"># Load prescriptions</span>
<span class="linenos">341</span> <span class="c1"># ------------------</span>
<span class="linenos">342</span> <span class="c1"># Load prescription data (limited to first nrows).</span>
<span class="linenos">343</span> <span class="n">use</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;prescriptions.csv&#39;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="linenos">344</span>
<span class="linenos">345</span> <span class="c1"># Keep prescriptions which have also been tested</span>
<span class="linenos">346</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">use</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">347</span> <span class="n">aux</span><span class="o">.</span><span class="n">drug</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">drug</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="linenos">348</span> <span class="n">aux</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">aux</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span>
<span class="linenos">349</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">drug</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">antimicrobial_code</span><span class="o">.</span><span class="n">unique</span><span class="p">())]</span>
<span class="linenos">350</span>
<span class="linenos">351</span> <span class="c1"># Rename variables</span>
<span class="linenos">352</span> <span class="n">susceptibility</span><span class="p">,</span> <span class="n">prescription</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">aux</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>c:\users\kelda\desktop\repositories\virtualenvs\venv-py3790-psc\lib\site-packages\sphinx_gallery\gen_rst.py:516: DtypeWarning:

Columns (16,23) have mixed types.Specify dtype option on import or set low_memory=False.

c:\users\kelda\desktop\repositories\virtualenvs\venv-py3790-psc\lib\site-packages\sphinx_gallery\gen_rst.py:516: DtypeWarning:

Columns (7) have mixed types.Specify dtype option on import or set low_memory=False.
</pre></div>
</div>
<p>Lets visualise microbiology data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">356</span> <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">357</span>     <span class="n">print_example_heading</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">358</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Susceptibility:&#39;</span><span class="p">)</span>
<span class="linenos">359</span>     <span class="nb">print</span><span class="p">(</span><span class="n">susceptibility</span><span class="p">)</span>
<span class="linenos">360</span> <span class="n">susceptibility</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>laboratory_number</th>
      <th>specimen_code</th>
      <th>microorganism_code</th>
      <th>antimicrobial_code</th>
      <th>sensitivity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>2171-06-10</td>
      <td>3685553</td>
      <td>URINE</td>
      <td>ESCHERICHIA COLI</td>
      <td>AMPICILLIN</td>
      <td>sensitive</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2171-06-10</td>
      <td>3685553</td>
      <td>URINE</td>
      <td>ESCHERICHIA COLI</td>
      <td>CEFAZOLIN</td>
      <td>sensitive</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2171-06-10</td>
      <td>3685553</td>
      <td>URINE</td>
      <td>ESCHERICHIA COLI</td>
      <td>TRIMETHOPRIM/SULFA</td>
      <td>sensitive</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2171-06-10</td>
      <td>3685553</td>
      <td>URINE</td>
      <td>ESCHERICHIA COLI</td>
      <td>NITROFURANTOIN</td>
      <td>sensitive</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2171-06-10</td>
      <td>3685553</td>
      <td>URINE</td>
      <td>ESCHERICHIA COLI</td>
      <td>GENTAMICIN</td>
      <td>sensitive</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Lets visualise the prescription data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">364</span> <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">365</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Prescription:&#39;</span><span class="p">)</span>
<span class="linenos">366</span>     <span class="nb">print</span><span class="p">(</span><span class="n">prescription</span><span class="p">)</span>
<span class="linenos">367</span> <span class="n">prescription</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>subject_id</th>
      <th>hadm_id</th>
      <th>pharmacy_id</th>
      <th>starttime</th>
      <th>stoptime</th>
      <th>drug_type</th>
      <th>drug</th>
      <th>gsn</th>
      <th>ndc</th>
      <th>prod_strength</th>
      <th>form_rx</th>
      <th>dose_val_rx</th>
      <th>dose_unit_rx</th>
      <th>form_val_disp</th>
      <th>form_unit_disp</th>
      <th>doses_per_24_hrs</th>
      <th>route</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>26</th>
      <td>17868682</td>
      <td>25218370</td>
      <td>81568564</td>
      <td>2167-05-24 20:00:00</td>
      <td>2167-05-26 02:00:00</td>
      <td>MAIN</td>
      <td>CEFAZOLIN</td>
      <td>068632</td>
      <td>264310511.0</td>
      <td>2g Duplex Bag</td>
      <td>NaN</td>
      <td>2</td>
      <td>g</td>
      <td>1</td>
      <td>BAG</td>
      <td>3.0</td>
      <td>IV</td>
    </tr>
    <tr>
      <th>48</th>
      <td>17868682</td>
      <td>24052239</td>
      <td>59994266</td>
      <td>2167-06-20 23:00:00</td>
      <td>2167-06-22 11:00:00</td>
      <td>MAIN</td>
      <td>VANCOMYCIN</td>
      <td>043952</td>
      <td>338355248.0</td>
      <td>1g Frozen Bag</td>
      <td>NaN</td>
      <td>1000</td>
      <td>mg</td>
      <td>200</td>
      <td>mL</td>
      <td>2.0</td>
      <td>IV</td>
    </tr>
    <tr>
      <th>58</th>
      <td>17868682</td>
      <td>24052239</td>
      <td>39104292</td>
      <td>2167-06-22 20:00:00</td>
      <td>2167-06-25 12:00:00</td>
      <td>MAIN</td>
      <td>VANCOMYCIN</td>
      <td>009331</td>
      <td>409433201.0</td>
      <td>500mg Vial</td>
      <td>NaN</td>
      <td>1500</td>
      <td>mg</td>
      <td>3</td>
      <td>VIAL</td>
      <td>2.0</td>
      <td>IV</td>
    </tr>
    <tr>
      <th>60</th>
      <td>17868682</td>
      <td>24052239</td>
      <td>1791946</td>
      <td>2167-06-24 20:00:00</td>
      <td>2167-06-25 12:00:00</td>
      <td>MAIN</td>
      <td>VANCOMYCIN</td>
      <td>009331</td>
      <td>409433201.0</td>
      <td>500mg Vial</td>
      <td>NaN</td>
      <td>1500</td>
      <td>mg</td>
      <td>3</td>
      <td>VIAL</td>
      <td>2.0</td>
      <td>IV</td>
    </tr>
    <tr>
      <th>76</th>
      <td>12315540</td>
      <td>24554730</td>
      <td>25748315</td>
      <td>2172-08-15 11:00:00</td>
      <td>2172-08-16 20:00:00</td>
      <td>MAIN</td>
      <td>LEVOFLOXACIN</td>
      <td>029928</td>
      <td>45152510.0</td>
      <td>500mg Tablet</td>
      <td>NaN</td>
      <td>750</td>
      <td>mg</td>
      <td>1.5</td>
      <td>TAB</td>
      <td>0.0</td>
      <td>PO</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<br />
<br /><p>Lets compute the DRI</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">373</span> <span class="c1"># -------------------------------------------</span>
<span class="linenos">374</span> <span class="c1"># Compute SARI</span>
<span class="linenos">375</span> <span class="c1"># -------------------------------------------</span>
<span class="linenos">376</span>
<span class="linenos">377</span> <span class="c1"># .. note:: These are some possible options to group</span>
<span class="linenos">378</span> <span class="c1">#           data by a datetime column.</span>
<span class="linenos">379</span> <span class="c1">#</span>
<span class="linenos">380</span> <span class="c1">#             by year:    data.time.dt.year</span>
<span class="linenos">381</span> <span class="c1">#             by quarter: data.time.dt.to_period(&#39;Q&#39;)</span>
<span class="linenos">382</span> <span class="c1">#             by decade:  pd.Grouper(key=&#39;time&#39;, freq=&#39;10AS&#39;)</span>
<span class="linenos">383</span> <span class="c1">#             by century: data.time.dt.year // 100</span>
<span class="linenos">384</span>
<span class="linenos">385</span>
<span class="linenos">386</span> <span class="c1"># Libraries</span>
<span class="linenos">387</span> <span class="kn">from</span> <span class="nn">pyamr.core.sari</span> <span class="kn">import</span> <span class="n">SARI</span>
<span class="linenos">388</span>
<span class="linenos">389</span> <span class="c1"># Create sari instance</span>
<span class="linenos">390</span> <span class="n">sari</span> <span class="o">=</span> <span class="n">SARI</span><span class="p">(</span><span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
<span class="linenos">391</span>                      <span class="c1">#&#39;specimen_code&#39;,</span>
<span class="linenos">392</span>                      <span class="s1">&#39;microorganism_code&#39;</span><span class="p">,</span>
<span class="linenos">393</span>                      <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">,</span>
<span class="linenos">394</span>                      <span class="s1">&#39;sensitivity&#39;</span><span class="p">])</span>
<span class="linenos">395</span>
<span class="linenos">396</span> <span class="c1"># Compute SARI</span>
<span class="linenos">397</span> <span class="n">df3</span> <span class="o">=</span> <span class="n">sari</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">susceptibility</span><span class="p">,</span> <span class="n">return_frequencies</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">398</span>
<span class="linenos">399</span> <span class="c1"># .. note: Uncomment this line to create random use if the</span>
<span class="linenos">400</span> <span class="c1">#          prescription data is not available and we want</span>
<span class="linenos">401</span> <span class="c1">#          to simulate it.</span>
<span class="linenos">402</span>
<span class="linenos">403</span> <span class="c1"># Create random use</span>
<span class="linenos">404</span> <span class="c1">#df3[&#39;use&#39;] = np.random.randint(10, 600, df3.shape[0])</span>
<span class="linenos">405</span>
<span class="linenos">406</span> <span class="c1"># Compute the number of prescriptions</span>
<span class="linenos">407</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">prescription</span> \
<span class="linenos">408</span>     <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;drug&#39;</span><span class="p">])</span> \
<span class="linenos">409</span>     <span class="o">.</span><span class="n">drug</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;use&#39;</span><span class="p">)</span>
<span class="linenos">410</span> <span class="n">aux</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">]</span>
<span class="linenos">411</span>
<span class="linenos">412</span> <span class="c1"># Merge susceptibility and prescription data</span>
<span class="linenos">413</span> <span class="n">df3</span> <span class="o">=</span> <span class="n">df3</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">aux</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
<span class="linenos">414</span>     <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
<span class="linenos">415</span>     <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">],</span>
<span class="linenos">416</span>     <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">])</span>
<span class="linenos">417</span>
<span class="linenos">418</span> <span class="c1"># Format the summary DataFrame</span>
<span class="linenos">419</span> <span class="n">df3</span> <span class="o">=</span> <span class="n">df3</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;microorganism_code&#39;</span><span class="p">,</span> <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">])</span>
<span class="linenos">420</span>
<span class="linenos">421</span> <span class="c1"># Compute drug resistance index</span>
<span class="linenos">422</span> <span class="n">df3</span> <span class="o">=</span> <span class="n">compute_drug_resistance_index</span><span class="p">(</span><span class="n">df3</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Lets see the results</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">426</span> <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">427</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result (MIMIC):&#39;</span><span class="p">)</span>
<span class="linenos">428</span>     <span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
<span class="linenos">429</span> <span class="n">df3</span><span class="p">[[</span><span class="s1">&#39;freq&#39;</span><span class="p">,</span>
<span class="linenos">430</span>      <span class="s1">&#39;sari&#39;</span><span class="p">,</span>
<span class="linenos">431</span>      <span class="s1">&#39;use&#39;</span><span class="p">,</span>
<span class="linenos">432</span>      <span class="s1">&#39;use_period&#39;</span><span class="p">,</span>
<span class="linenos">433</span>      <span class="s1">&#39;u_weight&#39;</span><span class="p">,</span>
<span class="linenos">434</span>      <span class="s1">&#39;w_rate&#39;</span><span class="p">,</span>
<span class="linenos">435</span>      <span class="s1">&#39;dri&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>freq</th>
      <th>sari</th>
      <th>use</th>
      <th>use_period</th>
      <th>u_weight</th>
      <th>w_rate</th>
      <th>dri</th>
    </tr>
    <tr>
      <th>time</th>
      <th>microorganism_code</th>
      <th>antimicrobial_code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2110</th>
      <th>BETA STREPTOCOCCUS GROUP B</th>
      <th>ERYTHROMYCIN</th>
      <td>1.0</td>
      <td>1.00</td>
      <td>3</td>
      <td>30</td>
      <td>0.100</td>
      <td>0.100</td>
      <td>0.682</td>
    </tr>
    <tr>
      <th>CORYNEBACTERIUM UREALYTICUM SP. NOV.</th>
      <th>ERYTHROMYCIN</th>
      <td>1.0</td>
      <td>1.00</td>
      <td>3</td>
      <td>30</td>
      <td>0.100</td>
      <td>0.100</td>
      <td>0.682</td>
    </tr>
    <tr>
      <th>POSITIVE FOR GROUP B BETA STREPTOCOCCI</th>
      <th>ERYTHROMYCIN</th>
      <td>1.0</td>
      <td>1.00</td>
      <td>3</td>
      <td>30</td>
      <td>0.100</td>
      <td>0.100</td>
      <td>0.682</td>
    </tr>
    <tr>
      <th>POSITIVE FOR METHICILLIN RESISTANT STAPH AUREUS</th>
      <th>ERYTHROMYCIN</th>
      <td>1.0</td>
      <td>1.00</td>
      <td>3</td>
      <td>30</td>
      <td>0.100</td>
      <td>0.100</td>
      <td>0.682</td>
    </tr>
    <tr>
      <th>STAPH AUREUS COAG +</th>
      <th>ERYTHROMYCIN</th>
      <td>60.0</td>
      <td>0.65</td>
      <td>3</td>
      <td>30</td>
      <td>0.100</td>
      <td>0.065</td>
      <td>0.682</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">2210</th>
      <th>STAPHYLOCOCCUS, COAGULASE NEGATIVE</th>
      <th>VANCOMYCIN</th>
      <td>1.0</td>
      <td>0.00</td>
      <td>5</td>
      <td>75</td>
      <td>0.067</td>
      <td>0.000</td>
      <td>0.037</td>
    </tr>
    <tr>
      <th>ESCHERICHIA COLI</th>
      <th>MEROPENEM</th>
      <td>9.0</td>
      <td>0.00</td>
      <td>5</td>
      <td>75</td>
      <td>0.067</td>
      <td>0.000</td>
      <td>0.037</td>
    </tr>
    <tr>
      <th>KLEBSIELLA PNEUMONIAE</th>
      <th>MEROPENEM</th>
      <td>4.0</td>
      <td>0.00</td>
      <td>5</td>
      <td>75</td>
      <td>0.067</td>
      <td>0.000</td>
      <td>0.037</td>
    </tr>
    <tr>
      <th>PSEUDOMONAS AERUGINOSA</th>
      <th>MEROPENEM</th>
      <td>2.0</td>
      <td>0.00</td>
      <td>5</td>
      <td>75</td>
      <td>0.067</td>
      <td>0.000</td>
      <td>0.037</td>
    </tr>
    <tr>
      <th>SERRATIA MARCESCENS</th>
      <th>MEROPENEM</th>
      <td>1.0</td>
      <td>0.00</td>
      <td>5</td>
      <td>75</td>
      <td>0.067</td>
      <td>0.000</td>
      <td>0.037</td>
    </tr>
  </tbody>
</table>
<p>9938 rows × 7 columns</p>
</div>
</div>
<br />
<br /><p>Lets display DRI over time</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">443</span> <span class="c1"># Libraries</span>
<span class="linenos">444</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="linenos">445</span> <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="linenos">446</span>
<span class="linenos">447</span> <span class="c1"># Get first element by level.</span>
<span class="linenos">448</span> <span class="n">df4</span> <span class="o">=</span> <span class="n">df3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="linenos">449</span>
<span class="linenos">450</span> <span class="c1"># Display using lineplot</span>
<span class="linenos">451</span> <span class="c1">#sns.lineplot(data=df4.dri)</span>
<span class="linenos">452</span>
<span class="linenos">453</span> <span class="c1"># Display using plt.plot.</span>
<span class="linenos">454</span> <span class="c1">#plt.plot(df4.index, df4.dri, linewidth=0.75, markersize=3, marker=&#39;o&#39;)</span>
<span class="linenos">455</span>
<span class="linenos">456</span> <span class="c1"># Display using relplot</span>
<span class="linenos">457</span> <span class="n">sns</span><span class="o">.</span><span class="n">relplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df4</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;dri&#39;</span><span class="p">,</span>
<span class="linenos">458</span>     <span class="c1">#hue=&#39;event&#39;, style=&#39;event&#39;, col=&#39;region, palette=&#39;palette&#39;,</span>
<span class="linenos">459</span>     <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span>
<span class="linenos">460</span>     <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span>
<span class="linenos">461</span> <span class="p">)</span>
<span class="linenos">462</span>
<span class="linenos">463</span> <span class="c1"># Show</span>
<span class="linenos">464</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_drug_resistance_index_001.png" srcset="../../_images/sphx_glr_plot_drug_resistance_index_001.png" alt="plot drug resistance index" class = "sphx-glr-single-img"/><div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <code class="docutils literal notranslate"><span class="pre">MIMIC</span></code>, the deidentification process for structured data required
the removal of dates. In particular, dates were shifted into the future
by a random offset for each individual patient in a consistent manner to
preserve intervals, resulting in stays which occur sometime between the
years 2100 and 2200. Time of day, day of the week, and approximate
seasonality were conserved during date shifting.</p>
</div>
<ol class="loweralpha simple" start="4">
<li><p>Extra code</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">478</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">479</span><span class="sd"> # Define data</span>
<span class="linenos">480</span><span class="sd"> data = [</span>
<span class="linenos">481</span>
<span class="linenos">482</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2000, 0, 100, 10],</span>
<span class="linenos">483</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2000, 0, 100, 9],</span>
<span class="linenos">484</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2000, 0, 100, 8],</span>
<span class="linenos">485</span>
<span class="linenos">486</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2001, 50, 50, 10],</span>
<span class="linenos">487</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2001, 60, 40, 9],</span>
<span class="linenos">488</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2001, 70, 30, 8],</span>
<span class="linenos">489</span>
<span class="linenos">490</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2002, 50, 50, 10],</span>
<span class="linenos">491</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2002, 60, 40, 10],</span>
<span class="linenos">492</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2002, 70, 30, 10],</span>
<span class="linenos">493</span>
<span class="linenos">494</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2003, 50, 50, 10],</span>
<span class="linenos">495</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2003, 60, 40, 11],</span>
<span class="linenos">496</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2003, 70, 30, 12],</span>
<span class="linenos">497</span>
<span class="linenos">498</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2004, 50, 50, 16],</span>
<span class="linenos">499</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2004, 60, 40, 22],</span>
<span class="linenos">500</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2004, 70, 30, 30],</span>
<span class="linenos">501</span>
<span class="linenos">502</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2005, 30, 70, 16],</span>
<span class="linenos">503</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2005, 30, 70, 22],</span>
<span class="linenos">504</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2005, 30, 70, 30],</span>
<span class="linenos">505</span>
<span class="linenos">506</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2006, 50, 50, 16],</span>
<span class="linenos">507</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2006, 60, 40, 22],</span>
<span class="linenos">508</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2006, 70, 30, 22],</span>
<span class="linenos">509</span>
<span class="linenos">510</span><span class="sd">     [&#39;o1&#39;, &#39;a1&#39;, 2007, 100, 0, 10],</span>
<span class="linenos">511</span><span class="sd">     [&#39;o1&#39;, &#39;a2&#39;, 2007, 100, 0, 9],</span>
<span class="linenos">512</span><span class="sd">     [&#39;o1&#39;, &#39;a3&#39;, 2007, 100, 0, 8],</span>
<span class="linenos">513</span>
<span class="linenos">514</span><span class="sd">     [&#39;o2&#39;, &#39;a1&#39;, 2001, 50, 50, 16],</span>
<span class="linenos">515</span><span class="sd">     [&#39;o2&#39;, &#39;a2&#39;, 2001, 60, 40, 22],</span>
<span class="linenos">516</span><span class="sd">     [&#39;o2&#39;, &#39;a3&#39;, 2001, 70, 30, 22],</span>
<span class="linenos">517</span><span class="sd"> ]</span>
<span class="linenos">518</span>
<span class="linenos">519</span>
<span class="linenos">520</span><span class="sd"> # Create DataFrame</span>
<span class="linenos">521</span><span class="sd"> df = pd.DataFrame(data,</span>
<span class="linenos">522</span><span class="sd">     columns=[&#39;o&#39;, &#39;a&#39;, &#39;year&#39;, &#39;R&#39;, &#39;S&#39;, &#39;dose&#39;])</span>
<span class="linenos">523</span>
<span class="linenos">524</span><span class="sd"> # Format DataFrame</span>
<span class="linenos">525</span><span class="sd"> df.year = pd.to_datetime(df.year, format=&#39;%Y&#39;)</span>
<span class="linenos">526</span><span class="sd"> df[&#39;r_prop&#39;] = df.R / (df.R + df.S)                                         # resistance proportion</span>
<span class="linenos">527</span><span class="sd"> df[&#39;d_prop&#39;] = df.dose / df.groupby(by=[&#39;o&#39;, &#39;year&#39;]).dose.transform(&#39;sum&#39;) # dose proportion</span>
<span class="linenos">528</span>
<span class="linenos">529</span><span class="sd"> # Show</span>
<span class="linenos">530</span><span class="sd"> print(&quot;Data:&quot;)</span>
<span class="linenos">531</span><span class="sd"> print(df)</span>
<span class="linenos">532</span>
<span class="linenos">533</span><span class="sd"> # Example 1: Fixed</span>
<span class="linenos">534</span><span class="sd"> # ----------------</span>
<span class="linenos">535</span>
<span class="linenos">536</span><span class="sd"> # Define p and q</span>
<span class="linenos">537</span><span class="sd"> p = df.r_prop</span>
<span class="linenos">538</span><span class="sd"> q = df.d_prop</span>
<span class="linenos">539</span>
<span class="linenos">540</span><span class="sd"> # Compute</span>
<span class="linenos">541</span><span class="sd"> r0 = (p * q).sum()</span>
<span class="linenos">542</span><span class="sd"> r1 = np.dot(p, q)</span>
<span class="linenos">543</span><span class="sd"> r2 = np.matmul(p, q)</span>
<span class="linenos">544</span>
<span class="linenos">545</span><span class="sd"> # Show</span>
<span class="linenos">546</span><span class="sd"> print(&quot;\n&quot; + &quot;=&quot;*80 + &quot;\nExample 1\n&quot; + &quot;=&quot;*80)</span>
<span class="linenos">547</span><span class="sd"> print(r0)</span>
<span class="linenos">548</span><span class="sd"> print(r1)</span>
<span class="linenos">549</span><span class="sd"> print(r2)</span>
<span class="linenos">550</span>
<span class="linenos">551</span>
<span class="linenos">552</span>
<span class="linenos">553</span><span class="sd"> # Example 2: Manual</span>
<span class="linenos">554</span><span class="sd"> # -----------------</span>
<span class="linenos">555</span>
<span class="linenos">556</span><span class="sd"> # Initialize</span>
<span class="linenos">557</span><span class="sd"> qik0 = None</span>
<span class="linenos">558</span><span class="sd"> v_fixed = []</span>
<span class="linenos">559</span><span class="sd"> v_evolv = []</span>
<span class="linenos">560</span>
<span class="linenos">561</span><span class="sd"> # Loop</span>
<span class="linenos">562</span><span class="sd"> for i,g in df.groupby(by=[&#39;o&#39;, &#39;year&#39;]):</span>
<span class="linenos">563</span><span class="sd">     if qik0 is None:</span>
<span class="linenos">564</span><span class="sd">         qik0 = list(g.groupby(by=&#39;year&#39;))[0][1].d_prop</span>
<span class="linenos">565</span>
<span class="linenos">566</span><span class="sd">     v_fixed.append({&#39;o&#39;: i[0], &#39;t&#39;: i[1], &#39;v&#39;: np.dot(g.r_prop, qik0.T)})</span>
<span class="linenos">567</span><span class="sd">     v_evolv.append({&#39;o&#39;: i[0], &#39;t&#39;: i[1], &#39;v&#39;: np.dot(g.r_prop, g.d_prop)})</span>
<span class="linenos">568</span>
<span class="linenos">569</span><span class="sd"> # Format</span>
<span class="linenos">570</span><span class="sd"> v_fixed = pd.DataFrame(v_fixed)</span>
<span class="linenos">571</span><span class="sd"> v_evolv = pd.DataFrame(v_evolv)</span>
<span class="linenos">572</span><span class="sd"> v_combn = v_evolv.merge(v_fixed, how=&#39;outer&#39;,</span>
<span class="linenos">573</span><span class="sd">     on=[&#39;o&#39;, &#39;t&#39;], suffixes=(&#39;_evolv&#39;, &#39;_fixed&#39;))</span>
<span class="linenos">574</span>
<span class="linenos">575</span><span class="sd"> # Show</span>
<span class="linenos">576</span><span class="sd"> print(&quot;\n&quot; + &quot;=&quot;*80 + &quot;\nExample 2\n&quot; + &quot;=&quot;*80)</span>
<span class="linenos">577</span><span class="sd"> print(v_combn)</span>
<span class="linenos">578</span>
<span class="linenos">579</span>
<span class="linenos">580</span>
<span class="linenos">581</span>
<span class="linenos">582</span><span class="sd"> # Example 3: Matrix</span>
<span class="linenos">583</span><span class="sd"> # -----------------</span>
<span class="linenos">584</span><span class="sd"> #</span>
<span class="linenos">585</span>
<span class="linenos">586</span><span class="sd"> print(&quot;\n&quot; + &quot;=&quot;*80 + &quot;\nExample 3\n&quot; + &quot;=&quot;*80)</span>
<span class="linenos">587</span>
<span class="linenos">588</span>
<span class="linenos">589</span><span class="sd"> m1 = pd.pivot_table(df, index=&#39;o&#39;, columns=&#39;a&#39;, values=&#39;r_prop&#39;)</span>
<span class="linenos">590</span><span class="sd"> m2 = pd.pivot_table(df, index=&#39;o&#39;, columns=&#39;a&#39;, values=&#39;d_prop&#39;)</span>
<span class="linenos">591</span><span class="sd"> print(m1)</span>
<span class="linenos">592</span><span class="sd"> print(m2)</span>
<span class="linenos">593</span><span class="sd"> print(m1*m2)</span>
<span class="linenos">594</span>
<span class="linenos">595</span><span class="sd"> # Loop</span>
<span class="linenos">596</span><span class="sd"> for i,g in df.groupby(by=&#39;year&#39;):</span>
<span class="linenos">597</span><span class="sd">     m1 = pd.pivot_table(g, index=&#39;o&#39;, columns=&#39;a&#39;, values=&#39;r_prop&#39;)</span>
<span class="linenos">598</span><span class="sd">     m2 = pd.pivot_table(g, index=&#39;o&#39;, columns=&#39;a&#39;, values=&#39;d_prop&#39;)</span>
<span class="linenos">599</span><span class="sd">     dri = np.dot(m1, m2.T)</span>
<span class="linenos">600</span><span class="sd">     print(i, dri)</span>
<span class="linenos">601</span>
<span class="linenos">602</span>
<span class="linenos">603</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="linenos">604</span>
<span class="linenos">605</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">606</span><span class="sd"> # Compute</span>
<span class="linenos">607</span><span class="sd"> df3[&#39;use_period&#39;] = df3 \</span>
<span class="linenos">608</span><span class="sd">     .groupby(level=0).use \</span>
<span class="linenos">609</span><span class="sd">     .transform(lambda x: x.sum())</span>
<span class="linenos">610</span><span class="sd"> df3[&#39;u_weight&#39;] = (df3.use / df3.use_period) #.round(decimals=2)</span>
<span class="linenos">611</span><span class="sd"> df3[&#39;w_rate&#39;] = (df3.sari * df3.u_weight)  #.round(decimals=3)</span>
<span class="linenos">612</span><span class="sd"> df3[&#39;dri&#39;] = df3 \</span>
<span class="linenos">613</span><span class="sd">     .groupby(by=&#39;time&#39;).w_rate \</span>
<span class="linenos">614</span><span class="sd">     .transform(lambda x: x.sum())</span>
<span class="linenos">615</span><span class="sd"> &quot;&quot;&quot;</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;\n# Compute\ndf3[&#39;use_period&#39;] = df3     .groupby(level=0).use     .transform(lambda x: x.sum())\ndf3[&#39;u_weight&#39;] = (df3.use / df3.use_period) #.round(decimals=2)\ndf3[&#39;w_rate&#39;] = (df3.sari * df3.u_weight)  #.round(decimals=3)\ndf3[&#39;dri&#39;] = df3     .groupby(by=&#39;time&#39;).w_rate     .transform(lambda x: x.sum())\n&quot;
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  4.303 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-utils-plot-drug-resistance-index-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/3c3e16e74e7eea45cc5de0ac62d27fcf/plot_drug_resistance_index.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_drug_resistance_index.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/bfbcbb8c355aba3aa4b81d0cf50676c7/plot_drug_resistance_index.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_drug_resistance_index.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="plot_collateral_sensitivity.html" class="btn btn-neutral float-left" title="Collateral Sensitivity Index" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="plot_generate_data_AST.html" class="btn btn-neutral float-right" title="Generate data AST" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2025, Bernard Hernandez.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>