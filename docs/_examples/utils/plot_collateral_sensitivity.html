<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Collateral Sensitivity Index &mdash; python-spare-code 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/python_icon_191765.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Drug Resistance Index" href="plot_drug_resistance_index.html" />
    <link rel="prev" title="MIC package" href="mic.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            python-spare-code
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/introduction.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">General</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#explainer-dashboard">Explainer Dashboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#factory-boy">Factory Boy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#jsonpickle">jsonpickle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#ldap">LDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#matplotlib-seaborn">Matplotlib / Seaborn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#other">Other</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#pandas">Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#plotly">Plotly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#scikits">Scikits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#shap">Shap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tableone">TableOne</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tensorflow">Tensorflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tpot">TPOT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#ukvi-trips">UKVI Trips</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#utils">Utils</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="mic.html">MIC package</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Collateral Sensitivity Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_drug_resistance_index.html">Drug Resistance Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_generate_data_AST.html">Generate data AST</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multi_armed_bandit.html">Multi-Armed bandit problems</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_mutual_information.html">Mutual Information Criteria</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_planet_orbit_v1.html">Drawing a planet orbit (stackoverflow)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_planet_orbit_v2.html">Drawing a planet orbit (customised)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_scale_colormap.html">Show colormap for various scalings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">python-spare-code</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">General</a></li>
      <li class="breadcrumb-item active">Collateral Sensitivity Index</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/_examples/utils/plot_collateral_sensitivity.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-examples-utils-plot-collateral-sensitivity-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="collateral-sensitivity-index">
<span id="sphx-glr-examples-utils-plot-collateral-sensitivity-py"></span><h1>Collateral Sensitivity Index<a class="headerlink" href="#collateral-sensitivity-index" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>In order to run the script in such a way that we can profile
the time used for each method, statement, .. use the following
command:</p>
<blockquote>
<div><p>$ python -m cProfile -s cumtime plot_collateral_sensitivity.py &gt; outcome.csv</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 11</span> <span class="c1"># Libraries</span>
<span class="linenos"> 12</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos"> 13</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos"> 14</span> <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="linenos"> 15</span> <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="linenos"> 16</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span> <span class="c1">#</span>
<span class="linenos"> 19</span> <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="linenos"> 20</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="linenos"> 21</span> <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="linenos"> 22</span> <span class="kn">from</span> <span class="nn">mic</span> <span class="kn">import</span> <span class="n">mutual_info_matrix_v3</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span> <span class="c1"># See https://matplotlib.org/devdocs/users/explain/customizing.html</span>
<span class="linenos"> 25</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="linenos"> 26</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="linenos"> 27</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="linenos"> 28</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span> <span class="k">def</span> <span class="nf">collateral_resistance_index</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="linenos"> 31</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Collateral Resistance Index</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="sd">     The collateral resistance index is based on the mutual</span>
<span class="linenos"> 34</span><span class="sd">     information matrix. This implementation assumes there</span>
<span class="linenos"> 35</span><span class="sd">     are two classes resistant (R) and sensitive (S).</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="sd">     Parameters</span>
<span class="linenos"> 38</span><span class="sd">     ----------</span>
<span class="linenos"> 39</span><span class="sd">     m: np.array</span>
<span class="linenos"> 40</span><span class="sd">         A numpy array with the mutual information matrix.</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="sd">     Returns</span>
<span class="linenos"> 43</span><span class="sd">     -------</span>
<span class="linenos"> 44</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos"> 45</span>     <span class="k">return</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span> <span class="k">def</span> <span class="nf">CRI</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="linenos"> 48</span>     <span class="n">ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="o">.</span><span class="n">SS</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">SR</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">RS</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">RR</span><span class="p">]])</span>
<span class="linenos"> 49</span>     <span class="n">m</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">ct</span><span class="o">=</span><span class="n">ct</span><span class="p">)</span>
<span class="linenos"> 50</span>     <span class="k">return</span> <span class="n">collateral_resistance_index</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span> <span class="k">def</span> <span class="nf">combo_v1</span><span class="p">():</span>
<span class="linenos"> 55</span>     <span class="c1"># Build combination</span>
<span class="linenos"> 56</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="linenos"> 57</span>     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]):</span>
<span class="linenos"> 58</span>         <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
<span class="linenos"> 59</span>             <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">index</span>
<span class="linenos"> 60</span>             <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
<span class="linenos"> 61</span>                 <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">],</span>
<span class="linenos"> 62</span>                 <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">],</span>
<span class="linenos"> 63</span>                 <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span>
<span class="linenos"> 64</span>                 <span class="s1">&#39;ay&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span>
<span class="linenos"> 65</span>                 <span class="s1">&#39;rx&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">],</span>
<span class="linenos"> 66</span>                 <span class="s1">&#39;ry&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
<span class="linenos"> 67</span>             <span class="p">})</span>
<span class="linenos"> 68</span>             <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
<span class="linenos"> 69</span>             <span class="c1"># c.append(s)</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 72</span><span class="sd">     # Build combination</span>
<span class="linenos"> 73</span><span class="sd">     c = pd.DataFrame()</span>
<span class="linenos"> 74</span><span class="sd">     for i, g in data.groupby([&#39;specimen_code&#39;,</span>
<span class="linenos"> 75</span><span class="sd">                               &#39;microorganism_code&#39;,</span>
<span class="linenos"> 76</span><span class="sd">                               &#39;laboratory_number&#39;]):</span>
<span class="linenos"> 77</span><span class="sd">         for index in list(combinations(g.index, 2)):</span>
<span class="linenos"> 78</span><span class="sd">             i, j = index</span>
<span class="linenos"> 79</span><span class="sd">             s = pd.Series({</span>
<span class="linenos"> 80</span><span class="sd">                 &#39;o&#39;: data.loc[i, &#39;microorganism_code&#39;],</span>
<span class="linenos"> 81</span><span class="sd">                 &#39;s&#39;: data.loc[i, &#39;laboratory_number&#39;],</span>
<span class="linenos"> 82</span><span class="sd">                 &#39;ax&#39;: data.loc[i, &#39;antimicrobial_code&#39;],</span>
<span class="linenos"> 83</span><span class="sd">                 &#39;ay&#39;: data.loc[j, &#39;antimicrobial_code&#39;],</span>
<span class="linenos"> 84</span><span class="sd">                 &#39;rx&#39;: data.loc[i, &#39;sensitivity&#39;],</span>
<span class="linenos"> 85</span><span class="sd">                 &#39;ry&#39;: data.loc[j, &#39;sensitivity&#39;]</span>
<span class="linenos"> 86</span><span class="sd">             })</span>
<span class="linenos"> 87</span><span class="sd">             c = pd.concat([c, s.to_frame().T])</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span><span class="sd">     # Add class</span>
<span class="linenos"> 91</span><span class="sd">     c[&#39;class&#39;] = c.rx + c.ry</span>
<span class="linenos"> 92</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos"> 93</span>     <span class="k">return</span> <span class="n">c</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span> <span class="k">def</span> <span class="nf">create_df_combo_v1</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">col_o</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="c1"># organism</span>
<span class="linenos"> 97</span>                           <span class="n">col_s</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="c1"># sample</span>
<span class="linenos"> 98</span>                           <span class="n">col_a</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="c1"># antimicrobial</span>
<span class="linenos"> 99</span>                           <span class="n">col_r</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span> <span class="c1"># outcome / result</span>
<span class="linenos">100</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="sd">     .. note:: There might be an issue if there are two different outcomes</span>
<span class="linenos">103</span><span class="sd">               for the same record. For example, a susceptibility test</span>
<span class="linenos">104</span><span class="sd">               record for penicillin (APEN) with R and another one with</span>
<span class="linenos">105</span><span class="sd">               S. Warn of this issue if it appears!</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="sd">     :param d:</span>
<span class="linenos">108</span><span class="sd">     :param col_o:</span>
<span class="linenos">109</span><span class="sd">     :param col_s:</span>
<span class="linenos">110</span><span class="sd">     :param col_a:</span>
<span class="linenos">111</span><span class="sd">     :param col_r:</span>
<span class="linenos">112</span><span class="sd">     :return:</span>
<span class="linenos">113</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">114</span>
<span class="linenos">115</span>     <span class="c1"># This is innefficient!</span>
<span class="linenos">116</span>
<span class="linenos">117</span>     <span class="c1"># Build combination</span>
<span class="linenos">118</span>     <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">119</span>     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">col_s</span><span class="p">,</span> <span class="n">col_o</span><span class="p">]):</span>
<span class="linenos">120</span>         <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">col_a</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos">121</span>             <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
<span class="linenos">122</span>                 <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_o</span><span class="p">],</span>
<span class="linenos">123</span>                 <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_s</span><span class="p">],</span>
<span class="linenos">124</span>                 <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_a</span><span class="p">],</span>
<span class="linenos">125</span>                 <span class="s1">&#39;ay&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">col_a</span><span class="p">],</span>
<span class="linenos">126</span>                 <span class="s1">&#39;rx&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_r</span><span class="p">],</span>
<span class="linenos">127</span>                 <span class="s1">&#39;ry&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">col_r</span><span class="p">]</span>
<span class="linenos">128</span>             <span class="p">})</span>
<span class="linenos">129</span>             <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="linenos">130</span>
<span class="linenos">131</span>
<span class="linenos">132</span>     <span class="c1"># Concatenate</span>
<span class="linenos">133</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">134</span>
<span class="linenos">135</span>     <span class="c1"># Add class</span>
<span class="linenos">136</span>     <span class="n">c</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rx</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">ry</span>
<span class="linenos">137</span>
<span class="linenos">138</span>     <span class="c1"># Return</span>
<span class="linenos">139</span>     <span class="k">return</span> <span class="n">c</span>
<span class="linenos">140</span>
<span class="linenos">141</span>
<span class="linenos">142</span> <span class="k">def</span> <span class="nf">create_combinations_v1</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">col_specimen</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
<span class="linenos">143</span>                               <span class="n">col_lab_id</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">,</span>
<span class="linenos">144</span>                               <span class="n">col_microorganism</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
<span class="linenos">145</span>                               <span class="n">col_antimicrobial</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
<span class="linenos">146</span>                               <span class="n">col_result</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
<span class="linenos">147</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Creates the dataframe with all combinations.</span>
<span class="linenos">148</span>
<span class="linenos">149</span><span class="sd">     Parameters</span>
<span class="linenos">150</span><span class="sd">     ----------</span>
<span class="linenos">151</span>
<span class="linenos">152</span><span class="sd">     Returns</span>
<span class="linenos">153</span><span class="sd">     --------</span>
<span class="linenos">154</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">155</span>     <span class="c1"># Initialize</span>
<span class="linenos">156</span>     <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">157</span>
<span class="linenos">158</span>     <span class="c1"># Loop</span>
<span class="linenos">159</span>     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">col_specimen</span><span class="p">,</span>
<span class="linenos">160</span>                            <span class="n">col_microorganism</span><span class="p">,</span>
<span class="linenos">161</span>                            <span class="n">col_lab_id</span><span class="p">]):</span>
<span class="linenos">162</span>         <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">col_antimicrobial</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos">163</span>             <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">164</span>                 <span class="s1">&#39;specimen&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_specimen</span><span class="p">],</span>
<span class="linenos">165</span>                 <span class="s1">&#39;lab_id&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_lab_id</span><span class="p">],</span>
<span class="linenos">166</span>                 <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_microorganism</span><span class="p">],</span>
<span class="linenos">167</span>                 <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_antimicrobial</span><span class="p">],</span>
<span class="linenos">168</span>                 <span class="s1">&#39;ay&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">col_antimicrobial</span><span class="p">],</span>
<span class="linenos">169</span>                 <span class="s1">&#39;rx&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_result</span><span class="p">],</span>
<span class="linenos">170</span>                 <span class="s1">&#39;ry&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">col_result</span><span class="p">]</span>
<span class="linenos">171</span>             <span class="p">})</span>
<span class="linenos">172</span>
<span class="linenos">173</span>     <span class="c1"># Create DataFrame</span>
<span class="linenos">174</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos">175</span>     <span class="c1"># Add class</span>
<span class="linenos">176</span>     <span class="n">c</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rx</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">ry</span>
<span class="linenos">177</span>     <span class="c1"># Return</span>
<span class="linenos">178</span>     <span class="k">return</span> <span class="n">c</span>
<span class="linenos">179</span>
<span class="linenos">180</span>
<span class="linenos">181</span> <span class="k">def</span> <span class="nf">create_combinations_v2</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">col_o</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
<span class="linenos">182</span>       <span class="n">col_s</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">col_a</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">col_r</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
<span class="linenos">183</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Creates the dataframe with all combinations.</span>
<span class="linenos">184</span>
<span class="linenos">185</span><span class="sd">     .. note:: There might be an issue if there are two different outcomes</span>
<span class="linenos">186</span><span class="sd">               for the same record. For example, a susceptibility test</span>
<span class="linenos">187</span><span class="sd">               record for penicillin (APEN) with R and another one with</span>
<span class="linenos">188</span><span class="sd">               S. Warn of this issue if it appears!</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="sd">     Parameters</span>
<span class="linenos">191</span><span class="sd">     ----------</span>
<span class="linenos">192</span>
<span class="linenos">193</span><span class="sd">     Returns</span>
<span class="linenos">194</span><span class="sd">     --------</span>
<span class="linenos">195</span>
<span class="linenos">196</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">197</span>     <span class="c1"># Initialize</span>
<span class="linenos">198</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="linenos">199</span>
<span class="linenos">200</span>     <span class="c1"># Loop</span>
<span class="linenos">201</span>     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">col_s</span><span class="p">,</span> <span class="n">col_o</span><span class="p">]):</span>
<span class="linenos">202</span>
<span class="linenos">203</span>         <span class="n">aux</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">204</span>         <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">col_a</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos">205</span>             <span class="n">aux</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">206</span>                 <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_a</span><span class="p">],</span>
<span class="linenos">207</span>                 <span class="s1">&#39;ay&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">col_a</span><span class="p">],</span>
<span class="linenos">208</span>                 <span class="s1">&#39;rx&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col_r</span><span class="p">],</span>
<span class="linenos">209</span>                 <span class="s1">&#39;ry&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">col_r</span><span class="p">]</span>
<span class="linenos">210</span>             <span class="p">})</span>
<span class="linenos">211</span>         <span class="n">aux</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
<span class="linenos">212</span>         <span class="n">aux</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">213</span>         <span class="n">aux</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">214</span>
<span class="linenos">215</span>         <span class="c1"># Concatenate</span>
<span class="linenos">216</span>         <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">aux</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">217</span>
<span class="linenos">218</span>     <span class="c1"># Add class</span>
<span class="linenos">219</span>     <span class="n">c</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rx</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">ry</span>
<span class="linenos">220</span>
<span class="linenos">221</span>     <span class="c1"># Return</span>
<span class="linenos">222</span>     <span class="k">return</span> <span class="n">c</span>
</pre></div>
</div>
<ol class="loweralpha simple">
<li><p>A basic example</p></li>
</ol>
<p>Note that the columns names are the initial for the following
full names: s=specimen, l=laboratory sample, o=organism,
a=antimicrobial and r=result</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">231</span> <span class="c1"># Create matrix</span>
<span class="linenos">232</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">233</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">234</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">235</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
<span class="linenos">236</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">237</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">238</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a3&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
<span class="linenos">239</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
<span class="linenos">240</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
<span class="linenos">241</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">242</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l4&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
<span class="linenos">243</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l4&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a1&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">244</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l5&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a5&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">245</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l6&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">246</span>     <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;l5&#39;</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">],</span>
<span class="linenos">247</span> <span class="p">]</span>
<span class="linenos">248</span>
<span class="linenos">249</span> <span class="c1"># Create DataFrame</span>
<span class="linenos">250</span> <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
<span class="linenos">251</span>     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">])</span>
<span class="linenos">252</span>
<span class="linenos">253</span> <span class="c1"># Show</span>
<span class="linenos">254</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data:&quot;</span><span class="p">)</span>
<span class="linenos">255</span> <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="linenos">256</span>
<span class="linenos">257</span> <span class="c1"># Create combo</span>
<span class="linenos">258</span> <span class="n">c</span> <span class="o">=</span> <span class="n">create_combinations_v1</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="linenos">259</span>
<span class="linenos">260</span> <span class="c1"># Show</span>
<span class="linenos">261</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Combinations (within isolates):&quot;</span><span class="p">)</span>
<span class="linenos">262</span> <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos">263</span>
<span class="linenos">264</span> <span class="c1"># Build contingency</span>
<span class="linenos">265</span> <span class="n">r</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ax&#39;</span><span class="p">,</span> <span class="s1">&#39;ay&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="linenos">266</span>
<span class="linenos">267</span> <span class="c1"># Show</span>
<span class="linenos">268</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Contingency:&quot;</span><span class="p">)</span>
<span class="linenos">269</span> <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="linenos">270</span>
<span class="linenos">271</span> <span class="c1"># Compute CRI</span>
<span class="linenos">272</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;MIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">CRI</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">mutual_info_matrix_v3</span><span class="p">,),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">273</span>
<span class="linenos">274</span> <span class="c1"># Show</span>
<span class="linenos">275</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Example 1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="linenos">276</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Result&quot;</span><span class="p">)</span>
<span class="linenos">277</span> <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="linenos">278</span>
<span class="linenos">279</span> <span class="c1"># Create index with all pairs</span>
<span class="linenos">280</span> <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
<span class="linenos">281</span>     <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>
<span class="linenos">282</span> <span class="p">)</span>
<span class="linenos">283</span>
<span class="linenos">284</span> <span class="c1"># Reformat</span>
<span class="linenos">285</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;MIS&#39;</span><span class="p">]</span> \
<span class="linenos">286</span>     <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>\
<span class="linenos">287</span>     <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="linenos">288</span>
<span class="linenos">289</span> <span class="c1"># Display</span>
<span class="linenos">290</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">aux</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>
<span class="linenos">291</span>     <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">70</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos">292</span>     <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">293</span>
<span class="linenos">294</span> <span class="c1"># Show</span>
<span class="linenos">295</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="linenos">296</span> <span class="c1">#plt.show()</span>
<span class="linenos">297</span>
<span class="linenos">298</span>
<span class="linenos">299</span>
<span class="linenos">300</span>
<span class="linenos">301</span> <span class="k">def</span> <span class="nf">load_susceptibility_nhs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">302</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Load and format MIMIC microbiology data.</span>
<span class="linenos">303</span>
<span class="linenos">304</span><span class="sd">     Parameters</span>
<span class="linenos">305</span><span class="sd">     ----------</span>
<span class="linenos">306</span><span class="sd">     **kwargs: dict-like</span>
<span class="linenos">307</span><span class="sd">         The arguments as used in pandas read_csv function</span>
<span class="linenos">308</span>
<span class="linenos">309</span><span class="sd">     Returns</span>
<span class="linenos">310</span><span class="sd">     --------</span>
<span class="linenos">311</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">312</span>     <span class="c1"># Load data</span>
<span class="linenos">313</span>     <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../datasets/susceptibility-nhs/&#39;</span><span class="p">)</span>
<span class="linenos">314</span>     <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;susceptibility-v0.0.1&#39;</span>
<span class="linenos">315</span>
<span class="linenos">316</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
<span class="linenos">317</span>         <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">318</span>             <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;susceptibility-*.csv&#39;</span><span class="p">)])</span>
<span class="linenos">319</span>
<span class="linenos">320</span>     <span class="c1"># Format data</span>
<span class="linenos">321</span>     <span class="n">data</span><span class="o">.</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sensitivity</span> \
<span class="linenos">322</span>         <span class="o">.</span><span class="n">replace</span><span class="p">({</span>
<span class="linenos">323</span>             <span class="s1">&#39;sensitive&#39;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span>
<span class="linenos">324</span>             <span class="s1">&#39;resistant&#39;</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span>
<span class="linenos">325</span>             <span class="s1">&#39;intermediate&#39;</span><span class="p">:</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
<span class="linenos">326</span>             <span class="s1">&#39;highly resistant&#39;</span><span class="p">:</span> <span class="s1">&#39;HR&#39;</span>
<span class="linenos">327</span>     <span class="p">})</span>
<span class="linenos">328</span>
<span class="linenos">329</span>     <span class="c1"># Select specimen</span>
<span class="linenos">330</span>     <span class="c1"># data = data[data.specimen_code.isin([&#39;URICUL&#39;])]</span>
<span class="linenos">331</span>     <span class="c1"># data = data[data.microorganism_code.isin([&#39;SAUR&#39;, &#39;ECOL&#39;, &#39;PAER&#39;])]</span>
<span class="linenos">332</span>     <span class="c1"># data = data[data.sensitivity.isin([&#39;R&#39;, &#39;S&#39;])]</span>
<span class="linenos">333</span>     <span class="c1"># data = data[data.laboratory_number.isin([&#39;H1954180&#39;, &#39;M1596362&#39;])]</span>
<span class="linenos">334</span>
<span class="linenos">335</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;HR&#39;</span><span class="p">])]</span>
<span class="linenos">336</span>
<span class="linenos">337</span>     <span class="c1"># .. note:: For some reason, for the same specimen and antimicrobial</span>
<span class="linenos">338</span>     <span class="c1">#           there are sometimes contradictory outcomes (e.g. R and S)</span>
<span class="linenos">339</span>     <span class="c1">#           so we are removing this by keeping the last.</span>
<span class="linenos">340</span>
<span class="linenos">341</span>     <span class="c1"># Keep only last/first specimen (sometimes repeated)</span>
<span class="linenos">342</span>     <span class="n">subset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">343</span>     <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">)</span>
<span class="linenos">344</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="linenos">345</span>
<span class="linenos">346</span>     <span class="c1"># Further cleaning</span>
<span class="linenos">347</span>
<span class="linenos">348</span>     <span class="c1"># Return</span>
<span class="linenos">349</span>     <span class="k">return</span> <span class="n">data</span>
<span class="linenos">350</span>
<span class="linenos">351</span>
<span class="linenos">352</span> <span class="k">def</span> <span class="nf">load_susceptibility_mimic</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">353</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Load and format MIMIC microbiology data.</span>
<span class="linenos">354</span>
<span class="linenos">355</span><span class="sd">     Parameters</span>
<span class="linenos">356</span><span class="sd">     ----------</span>
<span class="linenos">357</span><span class="sd">     **kwargs: dict-like</span>
<span class="linenos">358</span><span class="sd">         The arguments as used in pandas read_csv function</span>
<span class="linenos">359</span>
<span class="linenos">360</span><span class="sd">     Returns</span>
<span class="linenos">361</span><span class="sd">     --------</span>
<span class="linenos">362</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">363</span>     <span class="c1"># Load data</span>
<span class="linenos">364</span>     <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../datasets/susceptibility-mimic/&#39;</span><span class="p">)</span>
<span class="linenos">365</span>     <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;microbiologyevents.csv&#39;</span>
<span class="linenos">366</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">367</span>
<span class="linenos">368</span>     <span class="c1"># Format data</span>
<span class="linenos">369</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">370</span>         <span class="s1">&#39;micro_specimen_id&#39;</span><span class="p">:</span> <span class="s1">&#39;laboratory_number&#39;</span><span class="p">,</span>
<span class="linenos">371</span>         <span class="s1">&#39;spec_type_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;specimen_code&#39;</span><span class="p">,</span>
<span class="linenos">372</span>         <span class="s1">&#39;org_name&#39;</span><span class="p">:</span> <span class="s1">&#39;microorganism_code&#39;</span><span class="p">,</span>
<span class="linenos">373</span>         <span class="s1">&#39;ab_name&#39;</span><span class="p">:</span> <span class="s1">&#39;antimicrobial_code&#39;</span><span class="p">,</span>
<span class="linenos">374</span>         <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="s1">&#39;sensitivity&#39;</span>
<span class="linenos">375</span>     <span class="p">})</span>
<span class="linenos">376</span>
<span class="linenos">377</span>     <span class="c1"># Keep only last/first specimen</span>
<span class="linenos">378</span>
<span class="linenos">379</span>     <span class="c1"># Remove inconsistent records, for example if for an specimen there are two</span>
<span class="linenos">380</span>     <span class="c1"># rows for the same antimicrobial. Or even worse, these two rows are</span>
<span class="linenos">381</span>     <span class="c1"># contradictory (e.g. R and S)</span>
<span class="linenos">382</span>
<span class="linenos">383</span>     <span class="c1"># Other cleaning.</span>
<span class="linenos">384</span>
<span class="linenos">385</span>     <span class="c1"># Return</span>
<span class="linenos">386</span>     <span class="k">return</span> <span class="n">data</span>
<span class="linenos">387</span>
<span class="linenos">388</span>
<span class="linenos">389</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">390</span><span class="sd"> # Load data</span>
<span class="linenos">391</span><span class="sd"> #data = load_susceptibility_mimic()</span>
<span class="linenos">392</span><span class="sd"> data = load_susceptibility_nhs()</span>
<span class="linenos">393</span>
<span class="linenos">394</span><span class="sd"> # Create combo</span>
<span class="linenos">395</span><span class="sd"> c = create_combinations_v1(data,</span>
<span class="linenos">396</span><span class="sd">     col_specimen=&#39;specimen_code&#39;,</span>
<span class="linenos">397</span><span class="sd">     col_lab_id=&#39;laboratory_number&#39;,</span>
<span class="linenos">398</span><span class="sd">     col_microorganism=&#39;microorganism_code&#39;,</span>
<span class="linenos">399</span><span class="sd">     col_antimicrobial=&#39;antimicrobial_code&#39;,</span>
<span class="linenos">400</span><span class="sd">     col_result=&#39;sensitivity&#39;)</span>
<span class="linenos">401</span>
<span class="linenos">402</span><span class="sd"> # Create folder if it does not exist.</span>
<span class="linenos">403</span><span class="sd"> today = datetime.now().strftime(&quot;%Y%m%d-%H%M%S&quot;)</span>
<span class="linenos">404</span><span class="sd"> path = Path(&#39;./outputs/cri/&#39;) / today</span>
<span class="linenos">405</span><span class="sd"> Path(path).mkdir(parents=True, exist_ok=True)</span>
<span class="linenos">406</span>
<span class="linenos">407</span><span class="sd"> # Save combinations file.</span>
<span class="linenos">408</span><span class="sd"> c.to_csv(path / &#39;combinations.csv&#39;)</span>
<span class="linenos">409</span>
<span class="linenos">410</span><span class="sd"> # Build contingency</span>
<span class="linenos">411</span><span class="sd"> r = c.groupby([&#39;specimen&#39;, &#39;o&#39;, &#39;ax&#39;, &#39;ay&#39;, &#39;class&#39;]).size().unstack()</span>
<span class="linenos">412</span>
<span class="linenos">413</span><span class="sd"> # Compute CRI</span>
<span class="linenos">414</span><span class="sd"> r[&#39;MIS&#39;] = r.fillna(0) \</span>
<span class="linenos">415</span><span class="sd">     .apply(CRI, args=(mutual_info_matrix_v3,), axis=1)</span>
<span class="linenos">416</span>
<span class="linenos">417</span><span class="sd"> # Show</span>
<span class="linenos">418</span><span class="sd"> print(&quot;\n&quot; + &quot;=&quot;*80 + &quot;\nExample 2\n&quot; + &quot;=&quot;*80)</span>
<span class="linenos">419</span><span class="sd"> print(&quot;\nResult&quot;)</span>
<span class="linenos">420</span><span class="sd"> print(r)</span>
<span class="linenos">421</span>
<span class="linenos">422</span><span class="sd"> # Save collateral sensitivity index file.</span>
<span class="linenos">423</span><span class="sd"> r.to_csv(path / &#39;contingency.csv&#39;)</span>
<span class="linenos">424</span><span class="sd"> &quot;&quot;&quot;</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_collateral_sensitivity_001.png" srcset="../../_images/sphx_glr_plot_collateral_sensitivity_001.png" alt="plot collateral sensitivity" class = "sphx-glr-single-img"/><p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Data:
     s   l   o   a  r
0   s1  l1  o1  a1  S
1   s1  l1  o1  a2  S
2   s1  l1  o1  a3  R
3   s1  l2  o1  a1  S
4   s1  l2  o1  a2  S
5   s1  l2  o1  a3  R
6   s1  l2  o1  a4  R
7   s1  l3  o1  a1  R
8   s1  l3  o1  a2  S
9   s1  l4  o1  a2  R
10  s1  l4  o1  a1  S
11  s1  l5  o1  a5  S
12  s1  l6  o1  a4  S
13  s1  l5  o1  a2  S

Combinations (within isolates):
   specimen lab_id   o  ax  ay rx ry class
0        s1     l1  o1  a1  a2  S  S    SS
1        s1     l1  o1  a1  a3  S  R    SR
2        s1     l1  o1  a2  a3  S  R    SR
3        s1     l2  o1  a1  a2  S  S    SS
4        s1     l2  o1  a1  a3  S  R    SR
5        s1     l2  o1  a1  a4  S  R    SR
6        s1     l2  o1  a2  a3  S  R    SR
7        s1     l2  o1  a2  a4  S  R    SR
8        s1     l2  o1  a3  a4  R  R    RR
9        s1     l3  o1  a1  a2  R  S    RS
10       s1     l4  o1  a1  a2  S  R    SR
11       s1     l5  o1  a2  a5  S  S    SS

Contingency:
class   RR   RS   SR   SS
ax ay
a1 a2  NaN  1.0  1.0  2.0
   a3  NaN  NaN  2.0  NaN
   a4  NaN  NaN  1.0  NaN
a2 a3  NaN  NaN  2.0  NaN
   a4  NaN  NaN  1.0  NaN
   a5  NaN  NaN  NaN  1.0
a3 a4  1.0  NaN  NaN  NaN

================================================================================
Example 1
================================================================================

Result
class   RR   RS   SR   SS  MIS
ax ay
a1 a2  NaN  1.0  1.0  2.0  0.0
   a3  NaN  NaN  2.0  NaN  0.0
   a4  NaN  NaN  1.0  NaN  0.0
a2 a3  NaN  NaN  2.0  NaN  0.0
   a4  NaN  NaN  1.0  NaN  0.0
   a5  NaN  NaN  NaN  1.0  0.0
a3 a4  1.0  NaN  NaN  NaN  0.0

&#39;\n# Load data\n#data = load_susceptibility_mimic()\ndata = load_susceptibility_nhs()\n\n# Create combo\nc = create_combinations_v1(data,\n    col_specimen=\&#39;specimen_code\&#39;,\n    col_lab_id=\&#39;laboratory_number\&#39;,\n    col_microorganism=\&#39;microorganism_code\&#39;,\n    col_antimicrobial=\&#39;antimicrobial_code\&#39;,\n    col_result=\&#39;sensitivity\&#39;)\n\n# Create folder if it does not exist.\ntoday = datetime.now().strftime(&quot;%Y%m%d-%H%M%S&quot;)\npath = Path(\&#39;./outputs/cri/\&#39;) / today\nPath(path).mkdir(parents=True, exist_ok=True)\n\n# Save combinations file.\nc.to_csv(path / \&#39;combinations.csv\&#39;)\n\n# Build contingency\nr = c.groupby([\&#39;specimen\&#39;, \&#39;o\&#39;, \&#39;ax\&#39;, \&#39;ay\&#39;, \&#39;class\&#39;]).size().unstack()\n\n# Compute CRI\nr[\&#39;MIS\&#39;] = r.fillna(0)     .apply(CRI, args=(mutual_info_matrix_v3,), axis=1)\n\n# Show\nprint(&quot;\n&quot; + &quot;=&quot;*80 + &quot;\nExample 2\n&quot; + &quot;=&quot;*80)\nprint(&quot;\nResult&quot;)\nprint(r)\n\n# Save collateral sensitivity index file.\nr.to_csv(path / \&#39;contingency.csv\&#39;)\n&#39;
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.225 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-utils-plot-collateral-sensitivity-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/83c329c17ca99a7159018d2522be5a7e/plot_collateral_sensitivity.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_collateral_sensitivity.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c091896b0b98cf60308166f3c48226fc/plot_collateral_sensitivity.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_collateral_sensitivity.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mic.html" class="btn btn-neutral float-left" title="MIC package" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="plot_drug_resistance_index.html" class="btn btn-neutral float-right" title="Drug Resistance Index" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2024, Bernard Hernandez.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>