<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>08. Patient therapy flow (sankey) &mdash; python-spare-code 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/python_icon_191765.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="10. Plot sparklines with weather" href="plot_main10_weather.html" />
    <link rel="prev" title="07. Plot Parallel with dengue" href="plot_main07_parallel_v2.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            python-spare-code
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/introduction.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">General</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#explainer-dashboard">Explainer Dashboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#factory-boy">Factory Boy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#jsonpickle">jsonpickle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#ldap">LDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#matplotlib-seaborn">Matplotlib / Seaborn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#other">Other</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#pandas">Pandas</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#plotly">Plotly</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_main01_roc.html">01. Plot ROC</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main02_distributions.html">02. Plot Distributions</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main03_sparklines.html">03. Plot Sparklines</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main04_2dhist.html">04. Histogram 2D</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main06_treemap_v1.html">06. Plot Treemap with coffee</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main06_treemap_v2.html">06. Plot Treemap with MIMIC</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main07_parallel_v1.html">07. Plot Parallel</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main07_parallel_v2.html">07. Plot Parallel with dengue</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">08. Patient therapy flow (sankey)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main10_weather.html">10. Plot sparklines with weather</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main11_updatemenus.html">11. Using updatemenus</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main12_mpl2ply.html">12. Matplotlib to Plotly</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main12_mpl2ply_shap.html">12. MPL2PLY SHAP summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main30_dash_LS.html">30. Dash LS (empty)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main30_dash_table.html">30. Dash Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_main31_sepsis_shap_boxplot.html">30. Sample shap.csv boxplot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#scikits">Scikits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#shap">Shap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tableone">TableOne</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tensorflow">Tensorflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tpot">TPOT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#ukvi-trips">UKVI Trips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#utils">Utils</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">python-spare-code</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">General</a></li>
      <li class="breadcrumb-item active">08. Patient therapy flow (sankey)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/_examples/plotly/plot_main08_sankey_v10.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-examples-plotly-plot-main08-sankey-v10-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="patient-therapy-flow-sankey">
<span id="sphx-glr-examples-plotly-plot-main08-sankey-v10-py"></span><h1>08. Patient therapy flow (sankey)<a class="headerlink" href="#patient-therapy-flow-sankey" title="Permalink to this heading"></a></h1>
<p>This Sankey diagram visualizes treatment pathways by showing the flow of therapies
between consecutive days. The width of each path is proportional to the volume of
these transitions, which should be interpreted based on the input data’s structure.
If the data contains a single entry for a given therapy per subject per day, the
flow represents the number of patients. However, if the data includes multiple
entries for the same therapy on a given day, such as for each dose, then the flow
represents the total number of applications.</p>
<p>It should be noted that the visualization’s level of detail can be modified directly
in the code. This allows the trajectories to be displayed by specific drug, broader
drug category, or the WHO AWaRe classification (Access, Watch, Reserve).</p>
<html>
<head><meta charset="utf-8" /></head>
<body>
    <div>                        <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>                <div id="6eb30568-c1d6-4150-8362-45537ff90719" class="plotly-graph-div" style="height:100%; width:100%;"></div>            <script type="text/javascript">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("6eb30568-c1d6-4150-8362-45537ff90719")) {                    Plotly.newPlot(                        "6eb30568-c1d6-4150-8362-45537ff90719",                        [{"arrangement":"snap","link":{"color":["rgba(222,158,214,0.4)","rgba(57,59,121,0.4)","rgba(231,186,82,0.4)","rgba(57,59,121,0.4)","rgba(57,59,121,0.4)","rgba(231,186,82,0.4)","rgba(222,158,214,0.4)","rgba(222,158,214,0.4)","rgba(222,158,214,0.4)","rgba(231,186,82,0.4)","rgba(170,170,170,0.4)","rgba(57,59,121,0.4)","rgba(231,186,82,0.4)","rgba(222,158,214,0.4)","rgba(57,59,121,0.4)","rgba(170,170,170,0.4)","rgba(222,158,214,0.4)","rgba(231,186,82,0.4)","rgba(57,59,121,0.4)","rgba(231,186,82,0.4)","rgba(170,170,170,0.4)","rgba(231,186,82,0.4)","rgba(57,59,121,0.4)","rgba(222,158,214,0.4)","rgba(57,59,121,0.4)","rgba(170,170,170,0.4)","rgba(231,186,82,0.4)","rgba(57,59,121,0.4)","rgba(222,158,214,0.4)","rgba(170,170,170,0.4)","rgba(57,59,121,0.4)","rgba(57,59,121,0.4)","rgba(222,158,214,0.4)","rgba(231,186,82,0.4)","rgba(170,170,170,0.4)","rgba(170,170,170,0.4)","rgba(222,158,214,0.4)","rgba(57,59,121,0.4)","rgba(231,186,82,0.4)","rgba(231,186,82,0.4)","rgba(222,158,214,0.4)","rgba(57,59,121,0.4)","rgba(222,158,214,0.4)","rgba(170,170,170,0.4)","rgba(231,186,82,0.4)","rgba(222,158,214,0.4)","rgba(170,170,170,0.4)","rgba(57,59,121,0.4)","rgba(57,59,121,0.4)","rgba(170,170,170,0.4)","rgba(222,158,214,0.4)","rgba(57,59,121,0.4)","rgba(231,186,82,0.4)","rgba(231,186,82,0.4)","rgba(222,158,214,0.4)","rgba(57,59,121,0.4)","rgba(57,59,121,0.4)","rgba(170,170,170,0.4)","rgba(170,170,170,0.4)","rgba(231,186,82,0.4)","rgba(231,186,82,0.4)","rgba(57,59,121,0.4)","rgba(57,59,121,0.4)","rgba(170,170,170,0.4)","rgba(231,186,82,0.4)","rgba(222,158,214,0.4)"],"source":[3,0,2,0,0,2,3,3,3,2,1,0,2,7,4,5,7,6,4,6,5,6,4,7,4,5,6,8,11,9,8,8,11,10,9,9,11,8,10,10,11,12,15,13,14,15,13,12,12,13,15,12,14,14,19,16,16,17,17,18,18,16,16,17,18,19],"target":[7,4,6,5,7,5,6,5,4,4,5,6,7,11,8,8,9,10,9,11,9,8,11,8,10,11,9,12,15,12,13,15,13,14,15,13,12,14,13,15,14,16,19,16,18,17,19,17,19,17,18,18,17,19,23,20,23,20,21,20,22,21,22,23,23,21],"value":[60,52,24,15,10,10,7,6,5,4,3,2,1,37,30,15,10,9,8,7,6,6,5,5,3,3,3,21,20,14,9,8,8,7,6,3,3,1,1,1,1,20,14,10,5,5,4,3,3,3,3,2,1,1,11,10,3,3,3,2,2,1,1,1,1,1]},"node":{"color":["#393b79","#aaaaaa","#e7ba52","#de9ed6","#393b79","#aaaaaa","#e7ba52","#de9ed6","#393b79","#aaaaaa","#e7ba52","#de9ed6","#393b79","#aaaaaa","#e7ba52","#de9ed6","#393b79","#aaaaaa","#e7ba52","#de9ed6","#393b79","#aaaaaa","#e7ba52","#de9ed6"],"label":["Access","No Therapy","Reserve","Watch","Access","No Therapy","Reserve","Watch","Access","No Therapy","Reserve","Watch","Access","No Therapy","Reserve","Watch","Access","No Therapy","Reserve","Watch","Access","No Therapy","Reserve","Watch"],"line":{"color":"black","width":0.5},"pad":20,"thickness":25,"x":[0.0,0.0,0.0,0.0,0.2,0.2,0.2,0.2,0.4,0.4,0.4,0.4,0.6,0.6,0.6,0.6,0.8,0.8,0.8,0.8,1.0,1.0,1.0,1.0]},"type":"sankey"}],                        {"annotations":[{"font":{"size":14},"showarrow":false,"text":"<b>Day 1</b>","x":0.0,"xanchor":"center","xref":"paper","y":-0.17,"yref":"paper"},{"font":{"size":14},"showarrow":false,"text":"<b>Day 2</b>","x":0.2,"xanchor":"center","xref":"paper","y":-0.17,"yref":"paper"},{"font":{"size":14},"showarrow":false,"text":"<b>Day 3</b>","x":0.4,"xanchor":"center","xref":"paper","y":-0.17,"yref":"paper"},{"font":{"size":14},"showarrow":false,"text":"<b>Day 4</b>","x":0.6,"xanchor":"center","xref":"paper","y":-0.17,"yref":"paper"},{"font":{"size":14},"showarrow":false,"text":"<b>Day 5</b>","x":0.8,"xanchor":"center","xref":"paper","y":-0.17,"yref":"paper"},{"font":{"size":14},"showarrow":false,"text":"<b>Day 6</b>","x":1.0,"xanchor":"center","xref":"paper","y":-0.17,"yref":"paper"}],"font":{"size":12},"margin":{"b":100,"l":30,"r":30,"t":60},"template":{"data":{"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"choropleth":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"choropleth"}],"contourcarpet":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"contourcarpet"}],"contour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"contour"}],"heatmapgl":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmapgl"}],"heatmap":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmap"}],"histogram2dcontour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2dcontour"}],"histogram2d":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2d"}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"mesh3d":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"mesh3d"}],"parcoords":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"parcoords"}],"pie":[{"automargin":true,"type":"pie"}],"scatter3d":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatter3d"}],"scattercarpet":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattercarpet"}],"scattergeo":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattergeo"}],"scattergl":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattergl"}],"scattermapbox":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattermapbox"}],"scatterpolargl":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolargl"}],"scatterpolar":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolar"}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"scatterternary":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterternary"}],"surface":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"surface"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}]},"layout":{"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"autotypenumbers":"strict","coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]],"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]},"colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"geo":{"bgcolor":"white","lakecolor":"white","landcolor":"#E5ECF6","showlakes":true,"showland":true,"subunitcolor":"white"},"hoverlabel":{"align":"left"},"hovermode":"closest","mapbox":{"style":"light"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"bgcolor":"#E5ECF6","radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","gridwidth":2,"linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white"},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","gridwidth":2,"linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white"},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","gridwidth":2,"linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white"}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"ternary":{"aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"bgcolor":"#E5ECF6","caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"title":{"x":0.05},"xaxis":{"automargin":true,"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","zerolinewidth":2},"yaxis":{"automargin":true,"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","zerolinewidth":2}}},"title":{"text":"<b>Antimicrobial Therapy Transitions (Aware View) - Top 10</b>","x":0.5}},                        {"responsive": true}                    )                };                            </script>        </div>
</body>
</html>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 19</span> <span class="c1"># Libraries</span>
<span class="linenos"> 20</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="linenos"> 21</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos"> 22</span> <span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="linenos"> 23</span> <span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span> <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 26</span>     <span class="vm">__file__</span>
<span class="linenos"> 27</span>     <span class="n">TERMINAL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 28</span> <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 29</span>     <span class="n">TERMINAL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span> <span class="c1"># =============================================================================</span>
<span class="linenos"> 32</span> <span class="c1"># LOOKUP TABLES &amp; CONSTANTS</span>
<span class="linenos"> 33</span> <span class="c1"># =============================================================================</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span> <span class="k">def</span> <span class="nf">drug_to_aware_default</span><span class="p">():</span>
<span class="linenos"> 36</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Create default drug to aware classes.&quot;&quot;&quot;</span>
<span class="linenos"> 37</span>     <span class="k">return</span> <span class="p">{</span>
<span class="linenos"> 38</span>         <span class="s2">&quot;amikacin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;amoxicillin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;co-amoxiclav&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span>
<span class="linenos"> 39</span>         <span class="s2">&quot;benzylpenicillin sodium&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;cefalexin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;cefazolin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span>
<span class="linenos"> 40</span>         <span class="s2">&quot;chloramphenicol&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;clindamycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;doxycycline&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span>
<span class="linenos"> 41</span>         <span class="s2">&quot;flucloxacillin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;gentamicin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;mecillinam&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span>
<span class="linenos"> 42</span>         <span class="s2">&quot;metronidazole&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;nitrofurantoin&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;pivmecillinam&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span>
<span class="linenos"> 43</span>         <span class="s2">&quot;co-trimoxazole&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;trimethoprim&quot;</span><span class="p">:</span> <span class="s2">&quot;Access&quot;</span><span class="p">,</span> <span class="s2">&quot;azithromycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span>
<span class="linenos"> 44</span>         <span class="s2">&quot;cefepime&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;ceftazidime&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;ceftriaxone&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span>
<span class="linenos"> 45</span>         <span class="s2">&quot;cefuroxime&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;ciprofloxacin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;clarithromycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span>
<span class="linenos"> 46</span>         <span class="s2">&quot;ertapenem&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;erythromycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;fosfomycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span>
<span class="linenos"> 47</span>         <span class="s2">&quot;levofloxacin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;meropenem&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;moxifloxacin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span>
<span class="linenos"> 48</span>         <span class="s2">&quot;piperacillin-tazobactam&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;teicoplanin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;temocillin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span>
<span class="linenos"> 49</span>         <span class="s2">&quot;vancomycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span> <span class="s2">&quot;aztreonam&quot;</span><span class="p">:</span> <span class="s2">&quot;Reserve&quot;</span><span class="p">,</span> <span class="s2">&quot;cefiderocol&quot;</span><span class="p">:</span> <span class="s2">&quot;Reserve&quot;</span><span class="p">,</span>
<span class="linenos"> 50</span>         <span class="s2">&quot;ceftazidime/avibactam&quot;</span><span class="p">:</span> <span class="s2">&quot;Reserve&quot;</span><span class="p">,</span> <span class="s2">&quot;ceftolozane/tazobactam&quot;</span><span class="p">:</span> <span class="s2">&quot;Reserve&quot;</span><span class="p">,</span>
<span class="linenos"> 51</span>         <span class="s2">&quot;colistin&quot;</span><span class="p">:</span> <span class="s2">&quot;Reserve&quot;</span><span class="p">,</span> <span class="s2">&quot;daptomycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Reserve&quot;</span><span class="p">,</span> <span class="s2">&quot;linezolid&quot;</span><span class="p">:</span> <span class="s2">&quot;Reserve&quot;</span><span class="p">,</span>
<span class="linenos"> 52</span>         <span class="s2">&quot;tazocin&quot;</span><span class="p">:</span> <span class="s2">&quot;Watch&quot;</span><span class="p">,</span>
<span class="linenos"> 53</span>         <span class="s1">&#39;no therapy&#39;</span><span class="p">:</span> <span class="s1">&#39;No Therapy&#39;</span>
<span class="linenos"> 54</span>     <span class="p">}</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span> <span class="k">def</span> <span class="nf">drug_to_aware_class_winnie</span><span class="p">():</span>
<span class="linenos"> 57</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Create drug to aware class as defined by winnie&quot;&quot;&quot;</span>
<span class="linenos"> 58</span>     <span class="n">ACCESS_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 59</span>         <span class="s2">&quot;Amikacin&quot;</span><span class="p">,</span> <span class="s2">&quot;Amoxicillin&quot;</span><span class="p">,</span> <span class="s2">&quot;Amoxicillin (contains penicillin)&quot;</span><span class="p">,</span>
<span class="linenos"> 60</span>         <span class="s2">&quot;Amoxicillin/clavulanic-acid&quot;</span><span class="p">,</span> <span class="s2">&quot;Amoxiclavulanic-acid&quot;</span><span class="p">,</span>
<span class="linenos"> 61</span>         <span class="s2">&quot;Benzylpenicillin sodium&quot;</span><span class="p">,</span> <span class="s2">&quot;Co-amoxiclav&quot;</span><span class="p">,</span> <span class="s2">&quot;Co-amoxiclav (contains penicillin)&quot;</span><span class="p">,</span>
<span class="linenos"> 62</span>         <span class="s2">&quot;Co-amoxiclav (contains penicillin) (anes)&quot;</span><span class="p">,</span>
<span class="linenos"> 63</span>         <span class="s2">&quot;Co-amoxiclav 400mg/57mg in 5ml oral suspension (contains penicillin)&quot;</span><span class="p">,</span>
<span class="linenos"> 64</span>         <span class="s2">&quot;co-amoxiclav 250mg/62mg in 5ml oral suspension (contains penicillin)&quot;</span><span class="p">,</span>
<span class="linenos"> 65</span>         <span class="s2">&quot;Cefalexin&quot;</span><span class="p">,</span> <span class="s2">&quot;Cefazolin&quot;</span><span class="p">,</span> <span class="s2">&quot;Chloramphenicol&quot;</span><span class="p">,</span> <span class="s2">&quot;Clindamycin&quot;</span><span class="p">,</span> <span class="s2">&quot;Doxycycline&quot;</span><span class="p">,</span>
<span class="linenos"> 66</span>         <span class="s2">&quot;Flucloxacillin (contains penicillin)&quot;</span><span class="p">,</span> <span class="s2">&quot;Gentamicin&quot;</span><span class="p">,</span> <span class="s2">&quot;Gentamicin (anes)&quot;</span><span class="p">,</span>
<span class="linenos"> 67</span>         <span class="s2">&quot;Mecillinam&quot;</span><span class="p">,</span> <span class="s2">&quot;Metronidazole&quot;</span><span class="p">,</span> <span class="s2">&quot;Metronidazole (anes)&quot;</span><span class="p">,</span> <span class="s2">&quot;Metronidazole_IV&quot;</span><span class="p">,</span>
<span class="linenos"> 68</span>         <span class="s2">&quot;Metronidazole_oral&quot;</span><span class="p">,</span> <span class="s2">&quot;Nitrofurantoin&quot;</span><span class="p">,</span> <span class="s2">&quot;Co-amoxiclav in suspension&quot;</span><span class="p">,</span>
<span class="linenos"> 69</span>         <span class="s2">&quot;Pivmecillinam&quot;</span><span class="p">,</span> <span class="s2">&quot;Pivmecillinam (contains penicillin)&quot;</span><span class="p">,</span>
<span class="linenos"> 70</span>         <span class="s2">&quot;Sulfamethoxazole/trimethoprim&quot;</span><span class="p">,</span> <span class="s2">&quot;Trimethoprim&quot;</span><span class="p">,</span> <span class="s2">&quot;co-trimoxazole&quot;</span>
<span class="linenos"> 71</span>     <span class="p">]</span>
<span class="linenos"> 72</span>     <span class="n">WATCH_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 73</span>         <span class="s2">&quot;Azithromycin&quot;</span><span class="p">,</span> <span class="s2">&quot;Cefepime&quot;</span><span class="p">,</span> <span class="s2">&quot;Ceftazidime&quot;</span><span class="p">,</span> <span class="s2">&quot;Ceftriaxone&quot;</span><span class="p">,</span> <span class="s2">&quot;Cefuroxime&quot;</span><span class="p">,</span>
<span class="linenos"> 74</span>         <span class="s2">&quot;Cefuroxime (anes)&quot;</span><span class="p">,</span> <span class="s2">&quot;Ciprofloxacin&quot;</span><span class="p">,</span> <span class="s2">&quot;Clarithromycin&quot;</span><span class="p">,</span> <span class="s2">&quot;Ertapenem&quot;</span><span class="p">,</span>
<span class="linenos"> 75</span>         <span class="s2">&quot;Erythromycin&quot;</span><span class="p">,</span> <span class="s2">&quot;Fosfomycin&quot;</span><span class="p">,</span> <span class="s2">&quot;Fosfomycin_oral&quot;</span><span class="p">,</span> <span class="s2">&quot;Levofloxacin&quot;</span><span class="p">,</span> <span class="s2">&quot;Meropenem&quot;</span><span class="p">,</span>
<span class="linenos"> 76</span>         <span class="s2">&quot;Moxifloxacin&quot;</span><span class="p">,</span> <span class="s2">&quot;Piperacillin/tazobactam&quot;</span><span class="p">,</span> <span class="s2">&quot;piperacillin-tazobactam (contains penicillin)&quot;</span><span class="p">,</span>
<span class="linenos"> 77</span>         <span class="s2">&quot;piperacillin + tazobactam (contains penicillin)&quot;</span><span class="p">,</span> <span class="s2">&quot;Teicoplanin&quot;</span><span class="p">,</span> <span class="s2">&quot;Teicoplanin (anes)&quot;</span><span class="p">,</span>
<span class="linenos"> 78</span>         <span class="s2">&quot;Temocillin&quot;</span><span class="p">,</span> <span class="s2">&quot;Temocillin (contains penicillin)&quot;</span><span class="p">,</span> <span class="s2">&quot;Vancomycin&quot;</span><span class="p">,</span>
<span class="linenos"> 79</span>         <span class="s2">&quot;Vancomycin (anes)&quot;</span><span class="p">,</span> <span class="s2">&quot;Vancomycin (anes) 1g&quot;</span><span class="p">,</span> <span class="s2">&quot;Vancomycin_IV&quot;</span><span class="p">,</span> <span class="s2">&quot;Vancomycin_oral&quot;</span>
<span class="linenos"> 80</span>     <span class="p">]</span>
<span class="linenos"> 81</span>     <span class="n">RESERVE_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 82</span>         <span class="s2">&quot;Aztreonam&quot;</span><span class="p">,</span> <span class="s2">&quot;Cefiderocol&quot;</span><span class="p">,</span> <span class="s2">&quot;Ceftazidime/avibactam&quot;</span><span class="p">,</span> <span class="s2">&quot;Ceftolozane/tazobactam&quot;</span><span class="p">,</span>
<span class="linenos"> 83</span>         <span class="s2">&quot;Colistin&quot;</span><span class="p">,</span> <span class="s2">&quot;Colistin_IV&quot;</span><span class="p">,</span> <span class="s2">&quot;Dalbavancin&quot;</span><span class="p">,</span> <span class="s2">&quot;Daptomycin&quot;</span><span class="p">,</span> <span class="s2">&quot;Fosfomycin_IV&quot;</span><span class="p">,</span>
<span class="linenos"> 84</span>         <span class="s2">&quot;Iclaprim&quot;</span><span class="p">,</span> <span class="s2">&quot;Linezolid&quot;</span><span class="p">,</span> <span class="s2">&quot;Tigecycline&quot;</span>
<span class="linenos"> 85</span>     <span class="p">]</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span>     <span class="c1"># Define lookup table as this is more efficient for lookup than searching</span>
<span class="linenos"> 88</span>     <span class="c1"># through lists every time. We convert all drug names to lowercase to</span>
<span class="linenos"> 89</span>     <span class="c1"># ensure case-insensitive matching.</span>
<span class="linenos"> 90</span>     <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">drug</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="s2">&quot;Access&quot;</span> <span class="k">for</span> <span class="n">drug</span> <span class="ow">in</span> <span class="n">ACCESS_LIST</span><span class="p">}</span>
<span class="linenos"> 91</span>     <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">drug</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="s2">&quot;Watch&quot;</span> <span class="k">for</span> <span class="n">drug</span> <span class="ow">in</span> <span class="n">WATCH_LIST</span><span class="p">})</span>
<span class="linenos"> 92</span>     <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">drug</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="s2">&quot;Reserve&quot;</span> <span class="k">for</span> <span class="n">drug</span> <span class="ow">in</span> <span class="n">RESERVE_LIST</span><span class="p">})</span>
<span class="linenos"> 93</span>     <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;No therapy&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="s1">&#39;No Therapy&#39;</span><span class="p">})</span>
<span class="linenos"> 94</span>     <span class="k">return</span> <span class="n">d</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span> <span class="n">DRUG_TO_AWARE_CLASS</span> <span class="o">=</span> <span class="n">drug_to_aware_default</span><span class="p">()</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span> <span class="c1"># .. note:: Please be aware that this list is not exhaustive. Any antibiotics not assigned</span>
<span class="linenos"> 99</span> <span class="c1">#           to a specific category are currently labeled as &#39;Unknown&#39;. To ensure complete</span>
<span class="linenos">100</span> <span class="c1">#           coverage, please expand the list to encompass all items.</span>
<span class="linenos">101</span> <span class="c1"># .. note:: Ensure keys are lowercase.</span>
<span class="linenos">102</span>
<span class="linenos">103</span> <span class="n">DRUG_TO_CLASS</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">104</span>     <span class="s2">&quot;amoxicillin&quot;</span><span class="p">:</span> <span class="s2">&quot;Penicillin&quot;</span><span class="p">,</span> <span class="s2">&quot;flucloxacillin&quot;</span><span class="p">:</span> <span class="s2">&quot;Penicillin&quot;</span><span class="p">,</span> <span class="s2">&quot;pivmecillinam&quot;</span><span class="p">:</span> <span class="s2">&quot;Penicillin&quot;</span><span class="p">,</span>
<span class="linenos">105</span>     <span class="s2">&quot;co-amoxiclav&quot;</span><span class="p">:</span> <span class="s2">&quot;Penicillin and beta-lactamase inhibitor&quot;</span><span class="p">,</span> <span class="s2">&quot;tazocin&quot;</span><span class="p">:</span> <span class="s2">&quot;Penicillin and beta-lactamase inhibitor&quot;</span><span class="p">,</span>
<span class="linenos">106</span>     <span class="s2">&quot;piperacillin-tazobactam&quot;</span><span class="p">:</span> <span class="s2">&quot;Penicillin and beta-lactamase inhibitor&quot;</span><span class="p">,</span> <span class="s2">&quot;cefuroxime&quot;</span><span class="p">:</span> <span class="s2">&quot;2nd Gen Cephalosporin&quot;</span><span class="p">,</span>
<span class="linenos">107</span>     <span class="s2">&quot;ceftriaxone&quot;</span><span class="p">:</span> <span class="s2">&quot;3rd Gen Cephalosporin&quot;</span><span class="p">,</span> <span class="s2">&quot;ceftazidime&quot;</span><span class="p">:</span> <span class="s2">&quot;3rd Gen Cephalosporin&quot;</span><span class="p">,</span>
<span class="linenos">108</span>     <span class="s2">&quot;cefepime&quot;</span><span class="p">:</span> <span class="s2">&quot;4th Gen Cephalosporin&quot;</span><span class="p">,</span> <span class="s2">&quot;meropenem&quot;</span><span class="p">:</span> <span class="s2">&quot;Carbapenem&quot;</span><span class="p">,</span> <span class="s2">&quot;aztreonam&quot;</span><span class="p">:</span> <span class="s2">&quot;Monobactam&quot;</span><span class="p">,</span>
<span class="linenos">109</span>     <span class="s2">&quot;gentamicin&quot;</span><span class="p">:</span> <span class="s2">&quot;Aminoglycoside&quot;</span><span class="p">,</span> <span class="s2">&quot;amikacin&quot;</span><span class="p">:</span> <span class="s2">&quot;Aminoglycoside&quot;</span><span class="p">,</span> <span class="s2">&quot;ciprofloxacin&quot;</span><span class="p">:</span> <span class="s2">&quot;Fluoroquinolone&quot;</span><span class="p">,</span>
<span class="linenos">110</span>     <span class="s2">&quot;clarithromycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Macrolide&quot;</span><span class="p">,</span> <span class="s2">&quot;erythromycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Macrolide&quot;</span><span class="p">,</span> <span class="s2">&quot;vancomycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Glycopeptide&quot;</span><span class="p">,</span>
<span class="linenos">111</span>     <span class="s2">&quot;teicoplanin&quot;</span><span class="p">:</span> <span class="s2">&quot;Glycopeptide&quot;</span><span class="p">,</span> <span class="s2">&quot;linezolid&quot;</span><span class="p">:</span> <span class="s2">&quot;Oxazolidinone&quot;</span><span class="p">,</span> <span class="s2">&quot;metronidazole&quot;</span><span class="p">:</span> <span class="s2">&quot;Nitroimidazole&quot;</span><span class="p">,</span>
<span class="linenos">112</span>     <span class="s2">&quot;doxycycline&quot;</span><span class="p">:</span> <span class="s2">&quot;Tetracycline&quot;</span><span class="p">,</span> <span class="s2">&quot;fosfomycin&quot;</span><span class="p">:</span> <span class="s2">&quot;Phosphonic acid&quot;</span><span class="p">,</span> <span class="s2">&quot;co-trimoxazole&quot;</span><span class="p">:</span> <span class="s2">&quot;Folate pathway inhibitor&quot;</span><span class="p">,</span>
<span class="linenos">113</span>     <span class="s2">&quot;chloramphenicol&quot;</span><span class="p">:</span> <span class="s2">&quot;Amphenicol&quot;</span><span class="p">,</span> <span class="s2">&quot;temocillin&quot;</span><span class="p">:</span> <span class="s2">&quot;Penicillin&quot;</span><span class="p">,</span>
<span class="linenos">114</span>     <span class="s2">&quot;no therapy&quot;</span><span class="p">:</span> <span class="s2">&quot;No Therapy&quot;</span> <span class="c1"># To keep no therapy (otherwise will be set to Unkown)</span>
<span class="linenos">115</span> <span class="p">}</span>
<span class="linenos">116</span>
<span class="linenos">117</span> <span class="n">COLUMN_FOR_ANALYSIS</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">118</span>     <span class="s1">&#39;drug&#39;</span><span class="p">:</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">,</span>
<span class="linenos">119</span>     <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;drug_class&#39;</span><span class="p">,</span>
<span class="linenos">120</span>     <span class="s1">&#39;aware&#39;</span><span class="p">:</span> <span class="s1">&#39;aware_class&#39;</span>
<span class="linenos">121</span> <span class="p">}</span>
<span class="linenos">122</span>
<span class="linenos">123</span>
<span class="linenos">124</span> <span class="c1"># =============================================================================</span>
<span class="linenos">125</span> <span class="c1"># HELPER FUNCTIONS</span>
<span class="linenos">126</span> <span class="c1"># =============================================================================</span>
<span class="linenos">127</span>
<span class="linenos">128</span> <span class="k">def</span> <span class="nf">create_validation_data</span><span class="p">():</span>
<span class="linenos">129</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">130</span><span class="sd">     Creates a small, specific dataset with two patients to visually validate Sankey logic.</span>
<span class="linenos">131</span><span class="sd">     - Tests single therapy -&gt; combination therapy transition.</span>
<span class="linenos">132</span><span class="sd">     - Tests merging flows from different sources into one combination node.</span>
<span class="linenos">133</span><span class="sd">     - Tests combination therapy -&gt; single therapy transition.</span>
<span class="linenos">134</span><span class="sd">     - Tests transitions to &#39;No Therapy&#39; and terminating journeys.</span>
<span class="linenos">135</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">136</span>     <span class="n">records</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">137</span>         <span class="c1"># --- Patient 101: Longer journey with a combo ---</span>
<span class="linenos">138</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;amoxicillin&#39;</span><span class="p">},</span>
<span class="linenos">139</span>         <span class="c1"># Day 2 is a combination therapy</span>
<span class="linenos">140</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;amoxicillin&#39;</span><span class="p">},</span>
<span class="linenos">141</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;linezolid&#39;</span><span class="p">},</span>
<span class="linenos">142</span>         <span class="c1"># Day 3 transitions out of the combo</span>
<span class="linenos">143</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;vancomycin&#39;</span><span class="p">},</span>
<span class="linenos">144</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;No Therapy&#39;</span><span class="p">},</span>
<span class="linenos">145</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;No Therapy&#39;</span><span class="p">},</span>
<span class="linenos">146</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;vancomycin&#39;</span><span class="p">},</span>
<span class="linenos">147</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;vancomycin&#39;</span><span class="p">},</span>
<span class="linenos">148</span>
<span class="linenos">149</span>         <span class="c1"># --- Patient 102: Shorter journey, merges into the combo on Day 2 ---</span>
<span class="linenos">150</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;ciprofloxacin&#39;</span><span class="p">},</span>
<span class="linenos">151</span>         <span class="c1"># Day 2 is the same combination therapy as Patient 101</span>
<span class="linenos">152</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;amoxicillin&#39;</span><span class="p">},</span>
<span class="linenos">153</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;linezolid&#39;</span><span class="p">},</span>
<span class="linenos">154</span>         <span class="c1"># Day 3 transitions to the same drug, but journey ends here</span>
<span class="linenos">155</span>         <span class="p">{</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;vancomycin&#39;</span><span class="p">},</span>
<span class="linenos">156</span>     <span class="p">]</span>
<span class="linenos">157</span>     <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<span class="linenos">158</span>
<span class="linenos">159</span>
<span class="linenos">160</span> <span class="k">def</span> <span class="nf">remove_days_randomly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">missing_day_fraction</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<span class="linenos">161</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Remove some days randomly.&quot;&quot;&quot;</span>
<span class="linenos">162</span>     <span class="k">if</span> <span class="n">missing_day_fraction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">163</span>         <span class="c1"># Identify the indices of rows that are NOT the first day for any patient.</span>
<span class="linenos">164</span>         <span class="n">droppable_indices</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DAY_NUM&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="linenos">165</span>         <span class="c1"># Calculate how many of these rows to drop</span>
<span class="linenos">166</span>         <span class="n">num_to_drop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">droppable_indices</span><span class="p">)</span> <span class="o">*</span> <span class="n">missing_day_fraction</span><span class="p">)</span>
<span class="linenos">167</span>         <span class="c1"># Randomly choose the indices to drop from the droppable list</span>
<span class="linenos">168</span>         <span class="n">indices_to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">droppable_indices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_to_drop</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">169</span>         <span class="c1"># Drop the selected rows to create the final DataFrame</span>
<span class="linenos">170</span>         <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">indices_to_drop</span><span class="p">)</span>
<span class="linenos">171</span>     <span class="k">return</span> <span class="n">df</span>
<span class="linenos">172</span>
<span class="linenos">173</span>
<span class="linenos">174</span> <span class="k">def</span> <span class="nf">create_synthetic_data</span><span class="p">(</span><span class="n">num_patients</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_los</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
<span class="linenos">175</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">176</span><span class="sd">     Creates synthetic patient antibiotic data with variable lengths of stay.</span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="sd">     .. note:: It adds combined therapies to first 5.</span>
<span class="linenos">179</span><span class="sd">     .. note:: It removes some days with no therapy information.</span>
<span class="linenos">180</span>
<span class="linenos">181</span><span class="sd">     Args:</span>
<span class="linenos">182</span><span class="sd">         num_patients: The number of patients to simulate.</span>
<span class="linenos">183</span><span class="sd">         max_los: The maximum possible length of stay for any patient.</span>
<span class="linenos">184</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">185</span>     <span class="n">antibiotics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DRUG_TO_AWARE_CLASS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># + [&#39;No Therapy&#39;]</span>
<span class="linenos">186</span>     <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">187</span>     <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patients</span><span class="p">):</span>
<span class="linenos">188</span>         <span class="n">los</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_los</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">189</span>         <span class="n">current_therapy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">antibiotics</span><span class="p">)</span>
<span class="linenos">190</span>         <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="n">current_therapy</span><span class="p">})</span>
<span class="linenos">191</span>         <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">los</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">192</span>             <span class="k">if</span> <span class="n">current_therapy</span> <span class="o">==</span> <span class="s1">&#39;No Therapy&#39;</span><span class="p">:</span>
<span class="linenos">193</span>                 <span class="n">new_therapy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">antibiotics</span><span class="p">,</span>
<span class="linenos">194</span>                     <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.2</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">antibiotics</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">antibiotics</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">195</span>             <span class="k">else</span><span class="p">:</span>
<span class="linenos">196</span>                 <span class="n">other_abs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ab</span> <span class="k">for</span> <span class="n">ab</span> <span class="ow">in</span> <span class="n">antibiotics</span> <span class="k">if</span> <span class="n">ab</span> <span class="o">!=</span> <span class="n">current_therapy</span><span class="p">]</span>
<span class="linenos">197</span>                 <span class="n">new_therapy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">current_therapy</span><span class="p">,</span> <span class="s1">&#39;No Therapy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">other_abs</span><span class="p">,</span>
<span class="linenos">198</span>                     <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.3</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">other_abs</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">other_abs</span><span class="p">))</span>
<span class="linenos">199</span>             <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="n">new_therapy</span><span class="p">})</span>
<span class="linenos">200</span>             <span class="n">current_therapy</span> <span class="o">=</span> <span class="n">new_therapy</span>
<span class="linenos">201</span>     <span class="c1"># Add combination therapies for testing.</span>
<span class="linenos">202</span>     <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="linenos">203</span>         <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;amoxicillin&#39;</span><span class="p">})</span>
<span class="linenos">204</span>         <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;SUBJECT&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;DAY_NUM&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;linezolid&#39;</span><span class="p">})</span>
<span class="linenos">205</span>     <span class="c1"># Remove days randomly for testing</span>
<span class="linenos">206</span>     <span class="n">df</span> <span class="o">=</span> <span class="n">remove_days_randomly</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="n">missing_day_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="linenos">207</span>     <span class="c1"># Return</span>
<span class="linenos">208</span>     <span class="k">return</span> <span class="n">df</span>
<span class="linenos">209</span>
<span class="linenos">210</span>
<span class="linenos">211</span> <span class="k">def</span> <span class="nf">find_missing_days</span><span class="p">(</span><span class="n">group</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="linenos">212</span>                       <span class="n">subject_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">213</span>                       <span class="n">day_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">214</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;For a subject&#39;s data, return a DataFrame of missing days.&quot;&quot;&quot;</span>
<span class="linenos">215</span>     <span class="n">min_day</span><span class="p">,</span> <span class="n">max_day</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">day_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">group</span><span class="p">[</span><span class="n">day_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos">216</span>
<span class="linenos">217</span>     <span class="c1"># Use sets for a fast way to find what&#39;s missing</span>
<span class="linenos">218</span>     <span class="n">all_possible_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_day</span><span class="p">,</span> <span class="n">max_day</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">219</span>     <span class="n">existing_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">day_col</span><span class="p">])</span>
<span class="linenos">220</span>     <span class="n">missing_days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_possible_days</span> <span class="o">-</span> <span class="n">existing_days</span><span class="p">))</span>
<span class="linenos">221</span>
<span class="linenos">222</span>     <span class="c1"># Return a new DataFrame containing just the missing rows</span>
<span class="linenos">223</span>     <span class="k">if</span> <span class="n">missing_days</span><span class="p">:</span>
<span class="linenos">224</span>         <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="linenos">225</span>             <span class="n">subject_col</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="linenos">226</span>             <span class="n">day_col</span><span class="p">:</span> <span class="n">missing_days</span><span class="p">,</span>
<span class="linenos">227</span>             <span class="s1">&#39;drug_norm&#39;</span><span class="p">:</span> <span class="s1">&#39;No Therapy&#39;</span>
<span class="linenos">228</span>         <span class="p">})</span>
<span class="linenos">229</span>     <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Return nothing if no days are missing</span>
<span class="linenos">230</span>
<span class="linenos">231</span>
<span class="linenos">232</span> <span class="k">def</span> <span class="nf">process_patient_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="linenos">233</span>                          <span class="n">level</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">234</span>                          <span class="n">therapy_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">235</span>                          <span class="n">subject_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">236</span>                          <span class="n">day_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="linenos">237</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">238</span><span class="sd">     Applies classifications and correctly aggregates drug combinations for all</span>
<span class="linenos">239</span><span class="sd">     analysis levels to make the data &quot;pivot-ready&quot;.</span>
<span class="linenos">240</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="linenos">241</span>     <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">242</span>
<span class="linenos">243</span>     <span class="c1"># Create data with missing days and &#39;No Therapy&#39;</span>
<span class="linenos">244</span>     <span class="n">df_missing</span> <span class="o">=</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">subject_col</span><span class="p">)</span> \
<span class="linenos">245</span>         <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_missing_days</span><span class="p">,</span> <span class="n">subject_col</span><span class="o">=</span><span class="n">subject_col</span><span class="p">,</span> <span class="n">day_col</span><span class="o">=</span><span class="n">day_col</span><span class="p">)</span> \
<span class="linenos">246</span>         <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">247</span>
<span class="linenos">248</span>     <span class="c1"># Concatenate original data and missing data</span>
<span class="linenos">249</span>     <span class="n">df_copy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_copy</span><span class="p">,</span> <span class="n">df_missing</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">250</span>
<span class="linenos">251</span>     <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;class&#39;</span><span class="p">:</span>
<span class="linenos">252</span>         <span class="n">df_copy</span><span class="p">[</span><span class="n">therapy_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;drug_norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> \
<span class="linenos">253</span>             <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">DRUG_TO_CLASS</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
<span class="linenos">254</span>         <span class="c1"># Aggregate classes for combination therapies into a single sorted string</span>
<span class="linenos">255</span>         <span class="k">return</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_col</span><span class="p">,</span> <span class="n">day_col</span><span class="p">])[</span><span class="n">therapy_col</span><span class="p">]</span> \
<span class="linenos">256</span>             <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span> \
<span class="linenos">257</span>             <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="linenos">258</span>
<span class="linenos">259</span>     <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;aware&#39;</span><span class="p">:</span>
<span class="linenos">260</span>         <span class="n">df_copy</span><span class="p">[</span><span class="n">therapy_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;drug_norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> \
<span class="linenos">261</span>             <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">DRUG_TO_AWARE_CLASS</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
<span class="linenos">262</span>         <span class="c1"># For combinations, resolve by picking the highest-order class</span>
<span class="linenos">263</span>         <span class="n">aware_order</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Access&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Watch&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Reserve&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;No Therapy&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span>
<span class="linenos">264</span>         <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;aware_ordinal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="n">therapy_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">aware_order</span><span class="p">)</span>
<span class="linenos">265</span>         <span class="n">idx</span> <span class="o">=</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_col</span><span class="p">,</span> <span class="n">day_col</span><span class="p">])[</span><span class="s1">&#39;aware_ordinal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="linenos">266</span>         <span class="k">return</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;aware_ordinal&#39;</span><span class="p">)</span>
<span class="linenos">267</span>
<span class="linenos">268</span>     <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;drug&#39;</span><span class="p">:</span>
<span class="linenos">269</span>         <span class="c1"># Aggregates combination drugs into a single sorted string</span>
<span class="linenos">270</span>         <span class="k">return</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">subject_col</span><span class="p">,</span> <span class="n">day_col</span><span class="p">])[</span><span class="n">therapy_col</span><span class="p">]</span>\
<span class="linenos">271</span>             <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span> \
<span class="linenos">272</span>             <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="linenos">273</span>
<span class="linenos">274</span>     <span class="k">return</span> <span class="n">df_copy</span>
<span class="linenos">275</span>
<span class="linenos">276</span>
<span class="linenos">277</span> <span class="k">def</span> <span class="nf">limit_therapies_to_top_n</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">therapy_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="linenos">278</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Keeps the top N most frequent therapies and groups the rest into &#39;Other&#39;.&quot;&quot;&quot;</span>
<span class="linenos">279</span>     <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">df</span>
<span class="linenos">280</span>     <span class="n">top_n</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">therapy_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">281</span>     <span class="k">if</span> <span class="s1">&#39;No Therapy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top_n</span><span class="p">:</span>
<span class="linenos">282</span>         <span class="n">top_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No Therapy&#39;</span><span class="p">)</span>
<span class="linenos">283</span>     <span class="n">df</span><span class="p">[</span><span class="n">therapy_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">therapy_col</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">therapy_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_n</span><span class="p">),</span> <span class="s1">&#39;Other&#39;</span><span class="p">)</span>
<span class="linenos">284</span>     <span class="k">return</span> <span class="n">df</span>
<span class="linenos">285</span>
<span class="linenos">286</span>
<span class="linenos">287</span> <span class="k">def</span> <span class="nf">create_flow_from_patient_data_pivot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="linenos">288</span>                                         <span class="n">therapy_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">289</span>                                         <span class="n">subject_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">290</span>                                         <span class="n">day_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="linenos">291</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Transforms raw patient data into a Sankey-ready flow DataFrame.&quot;&quot;&quot;</span>
<span class="linenos">292</span>     <span class="n">patient_journeys</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">subject_col</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">day_col</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">therapy_col</span><span class="p">)</span>
<span class="linenos">293</span>     <span class="n">all_links</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">294</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">patient_journeys</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
<span class="linenos">295</span>         <span class="n">day_from</span><span class="p">,</span> <span class="n">day_to</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">296</span>         <span class="k">if</span> <span class="n">day_from</span> <span class="ow">in</span> <span class="n">patient_journeys</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">day_to</span> <span class="ow">in</span> <span class="n">patient_journeys</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="linenos">297</span>             <span class="n">transition_df</span> <span class="o">=</span> <span class="n">patient_journeys</span><span class="p">[[</span><span class="n">day_from</span><span class="p">,</span> <span class="n">day_to</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="linenos">298</span>             <span class="n">links</span> <span class="o">=</span> <span class="n">transition_df</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="linenos">299</span>             <span class="n">links</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">day_from</span><span class="p">:</span> <span class="s1">&#39;item_from&#39;</span><span class="p">,</span> <span class="n">day_to</span><span class="p">:</span> <span class="s1">&#39;item_to&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">300</span>             <span class="n">links</span><span class="p">[</span><span class="s1">&#39;day_from&#39;</span><span class="p">],</span> <span class="n">links</span><span class="p">[</span><span class="s1">&#39;day_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">day_from</span><span class="p">,</span> <span class="n">day_to</span>
<span class="linenos">301</span>             <span class="n">all_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
<span class="linenos">302</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">all_links</span><span class="p">:</span>
<span class="linenos">303</span>         <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;day_from&#39;</span><span class="p">,</span> <span class="s1">&#39;item_from&#39;</span><span class="p">,</span> <span class="s1">&#39;day_to&#39;</span><span class="p">,</span> <span class="s1">&#39;item_to&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>
<span class="linenos">304</span>     <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_links</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">305</span>
<span class="linenos">306</span>
<span class="linenos">307</span> <span class="k">def</span> <span class="nf">create_comprehensive_color_map</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="linenos">308</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Generates a consistent color map, including special colors for specified categories.&quot;&quot;&quot;</span>
<span class="linenos">309</span>     <span class="n">therapies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;item_from&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;item_to&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]))))</span>
<span class="linenos">310</span>     <span class="n">color_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">311</span>     <span class="n">special_colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;No Therapy&#39;</span><span class="p">:</span> <span class="s1">&#39;#aaaaaa&#39;</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">:</span> <span class="s1">&#39;#d3d3d3&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span> <span class="s1">&#39;#e5e5e5&#39;</span><span class="p">}</span>
<span class="linenos">312</span>     <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">special_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">313</span>         <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">therapies</span><span class="p">:</span>
<span class="linenos">314</span>             <span class="n">color_map</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
<span class="linenos">315</span>             <span class="n">therapies</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
<span class="linenos">316</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">therapies</span><span class="p">:</span> <span class="k">return</span> <span class="n">color_map</span>
<span class="linenos">317</span>     <span class="n">colormap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab20b&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">therapies</span><span class="p">))</span>
<span class="linenos">318</span>     <span class="n">hex_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="mi">255</span><span class="p">))</span> \
<span class="linenos">319</span>         <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">colormap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">therapies</span><span class="p">)))]</span>
<span class="linenos">320</span>     <span class="k">for</span> <span class="n">therapy</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">therapies</span><span class="p">,</span> <span class="n">hex_colors</span><span class="p">):</span> <span class="n">color_map</span><span class="p">[</span><span class="n">therapy</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
<span class="linenos">321</span>     <span class="k">return</span> <span class="n">color_map</span>
<span class="linenos">322</span>
<span class="linenos">323</span>
<span class="linenos">324</span> <span class="k">def</span> <span class="nf">plot_sankey_robust</span><span class="p">(</span><span class="n">flow_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">therapy_colors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">325</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Generates a Sankey diagram using a structural method that prevents backward links.&quot;&quot;&quot;</span>
<span class="linenos">326</span>     <span class="n">source_nodes</span> <span class="o">=</span> <span class="n">flow_df</span><span class="p">[[</span><span class="s1">&#39;day_from&#39;</span><span class="p">,</span> <span class="s1">&#39;item_from&#39;</span><span class="p">]]</span> \
<span class="linenos">327</span>         <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;day_from&#39;</span><span class="p">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;item_from&#39;</span><span class="p">:</span> <span class="s1">&#39;label&#39;</span><span class="p">})</span>
<span class="linenos">328</span>     <span class="n">target_nodes</span> <span class="o">=</span> <span class="n">flow_df</span><span class="p">[[</span><span class="s1">&#39;day_to&#39;</span><span class="p">,</span> <span class="s1">&#39;item_to&#39;</span><span class="p">]]</span> \
<span class="linenos">329</span>         <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;day_to&#39;</span><span class="p">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;item_to&#39;</span><span class="p">:</span> <span class="s1">&#39;label&#39;</span><span class="p">})</span>
<span class="linenos">330</span>     <span class="n">nodes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">source_nodes</span><span class="p">,</span> <span class="n">target_nodes</span><span class="p">])</span> \
<span class="linenos">331</span>         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span> \
<span class="linenos">332</span>         <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">333</span>     <span class="n">nodes_df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">index</span>
<span class="linenos">334</span>     <span class="n">node_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">nodes_df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_day_&#39;</span> <span class="o">+</span> <span class="n">nodes_df</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
<span class="linenos">335</span>     <span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;item_from&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_day_&#39;</span> <span class="o">+</span> <span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;day_from&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">node_map</span><span class="p">)</span>
<span class="linenos">336</span>     <span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;target_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;item_to&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_day_&#39;</span> <span class="o">+</span> <span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;day_to&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">node_map</span><span class="p">)</span>
<span class="linenos">337</span>     <span class="n">unique_days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nodes_df</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="linenos">338</span>     <span class="n">day_x_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">day</span><span class="p">:</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_days</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_days</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_days</span><span class="p">)}</span>
<span class="linenos">339</span>     <span class="n">node_x</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">day_x_map</span><span class="p">)</span>
<span class="linenos">340</span>     <span class="n">node_colors</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">therapy_colors</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;#CCCCCC&#39;</span><span class="p">)</span>
<span class="linenos">341</span>     <span class="n">link_colors</span> <span class="o">=</span> <span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;item_from&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">therapy_colors</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;#CCCCCC&#39;</span><span class="p">)</span> \
<span class="linenos">342</span>         <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;rgba(</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">,0.4)&quot;</span><span class="p">)</span>
<span class="linenos">343</span>     <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Sankey</span><span class="p">(</span>
<span class="linenos">344</span>         <span class="n">arrangement</span><span class="o">=</span><span class="s2">&quot;snap&quot;</span><span class="p">,</span>
<span class="linenos">345</span>         <span class="n">node</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
<span class="linenos">346</span>                   <span class="n">label</span><span class="o">=</span><span class="n">nodes_df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">node_colors</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">node_x</span><span class="p">),</span>
<span class="linenos">347</span>         <span class="n">link</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">],</span> <span class="n">target</span><span class="o">=</span><span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;target_id&#39;</span><span class="p">],</span>
<span class="linenos">348</span>                   <span class="n">value</span><span class="o">=</span><span class="n">flow_df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">link_colors</span><span class="p">)</span>
<span class="linenos">349</span>     <span class="p">)])</span>
<span class="linenos">350</span>     <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span> <span class="k">if</span> <span class="n">TERMINAL</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.17</span>
<span class="linenos">351</span>     <span class="n">annotations</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">352</span>         <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Day </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&lt;/b&gt;&quot;</span><span class="p">,</span> <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">353</span>             <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span> <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span> <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="linenos">354</span>                 <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">day_x_map</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="linenos">355</span>     <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
<span class="linenos">356</span>         <span class="n">title_text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&lt;/b&gt;&quot;</span><span class="p">,</span>
<span class="linenos">357</span>         <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="linenos">358</span>         <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
<span class="linenos">359</span>         <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
<span class="linenos">360</span>         <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos">361</span>     <span class="p">)</span>
<span class="linenos">362</span>
<span class="linenos">363</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">TERMINAL</span><span class="p">:</span>
<span class="linenos">364</span>         <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
<span class="linenos">365</span>
<span class="linenos">366</span>     <span class="k">return</span> <span class="n">fig</span>
<span class="linenos">367</span>
<span class="linenos">368</span>
<span class="linenos">369</span>
<span class="linenos">370</span>
<span class="linenos">371</span>
<span class="linenos">372</span> <span class="c1"># =============================================================================</span>
<span class="linenos">373</span> <span class="c1">#                                   MAIN</span>
<span class="linenos">374</span> <span class="c1"># =============================================================================</span>
<span class="linenos">375</span> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">376</span>
<span class="linenos">377</span>     <span class="c1"># .. note:: To ensure the logic is correct, you can add a test case. Create</span>
<span class="linenos">378</span>     <span class="c1">#           and filter synthetic patient with a specific therapy progression</span>
<span class="linenos">379</span>     <span class="c1">#           over several days. Then, run the script and confirm that the final</span>
<span class="linenos">380</span>     <span class="c1">#           plot accurately reflects this known pathway.</span>
<span class="linenos">381</span>
<span class="linenos">382</span>     <span class="c1"># Constants</span>
<span class="linenos">383</span>     <span class="n">N_PATIENTS</span> <span class="o">=</span> <span class="mi">200</span>          <span class="c1"># Number of patients</span>
<span class="linenos">384</span>     <span class="n">MAX_LOS</span> <span class="o">=</span> <span class="mi">6</span>                 <span class="c1"># Maximum length of stay.</span>
<span class="linenos">385</span>     <span class="n">TOP_N_THERAPIES</span> <span class="o">=</span> <span class="mi">10</span>       <span class="c1"># Filter by top most common therapies</span>
<span class="linenos">386</span>     <span class="n">ANALYSIS_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;aware&#39;</span>   <span class="c1"># Options (&#39;drug&#39;, &#39;class&#39; and &#39;aware&#39;)</span>
<span class="linenos">387</span>
<span class="linenos">388</span>     <span class="c1"># Define variables</span>
<span class="linenos">389</span>     <span class="n">therapy_col</span> <span class="o">=</span> <span class="n">COLUMN_FOR_ANALYSIS</span><span class="p">[</span><span class="n">ANALYSIS_LEVEL</span><span class="p">]</span>
<span class="linenos">390</span>     <span class="n">subject_col</span> <span class="o">=</span> <span class="s1">&#39;SUBJECT&#39;</span>
<span class="linenos">391</span>     <span class="n">day_col</span> <span class="o">=</span> <span class="s1">&#39;DAY_NUM&#39;</span>
<span class="linenos">392</span>
<span class="linenos">393</span>     <span class="c1"># Generate synthetic data.</span>
<span class="linenos">394</span>     <span class="n">patient_df</span> <span class="o">=</span> <span class="n">create_synthetic_data</span><span class="p">(</span><span class="n">num_patients</span><span class="o">=</span><span class="n">N_PATIENTS</span><span class="p">,</span> <span class="n">max_los</span><span class="o">=</span><span class="n">MAX_LOS</span><span class="p">)</span>
<span class="linenos">395</span>     <span class="c1">#patient_df = create_validation_data()</span>
<span class="linenos">396</span>
<span class="linenos">397</span>     <span class="c1"># Pre-process patient data</span>
<span class="linenos">398</span>     <span class="n">processed_df</span> <span class="o">=</span> <span class="n">process_patient_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">patient_df</span><span class="p">,</span>
<span class="linenos">399</span>                                         <span class="n">level</span><span class="o">=</span><span class="n">ANALYSIS_LEVEL</span><span class="p">,</span>
<span class="linenos">400</span>                                         <span class="n">therapy_col</span><span class="o">=</span><span class="n">therapy_col</span><span class="p">,</span>
<span class="linenos">401</span>                                         <span class="n">subject_col</span><span class="o">=</span><span class="n">subject_col</span><span class="p">,</span>
<span class="linenos">402</span>                                         <span class="n">day_col</span><span class="o">=</span><span class="n">day_col</span><span class="p">)</span>
<span class="linenos">403</span>
<span class="linenos">404</span>     <span class="c1"># Filter top n therapies</span>
<span class="linenos">405</span>     <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">limit_therapies_to_top_n</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">processed_df</span><span class="p">,</span>
<span class="linenos">406</span>                                            <span class="n">therapy_col</span><span class="o">=</span><span class="n">therapy_col</span><span class="p">,</span>
<span class="linenos">407</span>                                            <span class="n">n</span><span class="o">=</span><span class="n">TOP_N_THERAPIES</span><span class="p">)</span>
<span class="linenos">408</span>
<span class="linenos">409</span>     <span class="c1"># Generate flow data</span>
<span class="linenos">410</span>     <span class="n">flow_data</span> <span class="o">=</span> <span class="n">create_flow_from_patient_data_pivot</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">filtered_df</span><span class="p">,</span>
<span class="linenos">411</span>                                                     <span class="n">therapy_col</span><span class="o">=</span><span class="n">therapy_col</span><span class="p">,</span>
<span class="linenos">412</span>                                                     <span class="n">subject_col</span><span class="o">=</span><span class="n">subject_col</span><span class="p">,</span>
<span class="linenos">413</span>                                                     <span class="n">day_col</span><span class="o">=</span><span class="n">day_col</span><span class="p">)</span>
<span class="linenos">414</span>
<span class="linenos">415</span>     <span class="c1"># Display</span>
<span class="linenos">416</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<span class="linenos">417</span>
<span class="linenos">418</span>         <span class="c1"># .. note:: Create a custom color scheme to make information easier to understand.</span>
<span class="linenos">419</span>         <span class="c1">#           For example, you could use green, yellow, and red for statuses like</span>
<span class="linenos">420</span>         <span class="c1">#           &#39;access,&#39; &#39;watch,&#39; and &#39;reserve.&#39; You can also assign a unique color</span>
<span class="linenos">421</span>         <span class="c1">#           to each drug class and then use different shades of that color for</span>
<span class="linenos">422</span>         <span class="c1">#           the individual drugs within the class. For help with this, you can</span>
<span class="linenos">423</span>         <span class="c1">#           ask Gemini to generate the color palettes for you</span>
<span class="linenos">424</span>
<span class="linenos">425</span>         <span class="n">colors</span> <span class="o">=</span> <span class="n">create_comprehensive_color_map</span><span class="p">(</span><span class="n">flow_data</span><span class="p">)</span>
<span class="linenos">426</span>         <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Antimicrobial Therapy Transitions (</span><span class="si">{</span><span class="n">ANALYSIS_LEVEL</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> View)&quot;</span>
<span class="linenos">427</span>         <span class="k">if</span> <span class="n">TOP_N_THERAPIES</span><span class="p">:</span> <span class="n">plot_title</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; - Top </span><span class="si">{</span><span class="n">TOP_N_THERAPIES</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">428</span>         <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_sankey_robust</span><span class="p">(</span><span class="n">flow_data</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">)</span>
<span class="linenos">429</span>
<span class="linenos">430</span>         <span class="c1"># Show</span>
<span class="linenos">431</span>         <span class="kn">from</span> <span class="nn">plotly.io</span> <span class="kn">import</span> <span class="n">show</span>
<span class="linenos">432</span>         <span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="linenos">433</span>     <span class="k">else</span><span class="p">:</span>
<span class="linenos">434</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No flow data to plot. The dataset might be too small or filtered.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  1.277 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-plotly-plot-main08-sankey-v10-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/2345c2a5d65d7573bff8abf53c304eb1/plot_main08_sankey_v10.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_main08_sankey_v10.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/bae441a15ecfc3470d49e640f3d5926c/plot_main08_sankey_v10.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_main08_sankey_v10.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="plot_main07_parallel_v2.html" class="btn btn-neutral float-left" title="07. Plot Parallel with dengue" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="plot_main10_weather.html" class="btn btn-neutral float-right" title="10. Plot sparklines with weather" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2025, Bernard Hernandez.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>